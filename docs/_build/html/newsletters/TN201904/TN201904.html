<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using VBA Macros with Virtel &mdash; Virtel 9 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Virtel
              <img src="../../_static/logo_virtel_web.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                4.61
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../virtel.html">Virtel Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../newsletters.html">Technical Newsletters</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Virtel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Using VBA Macros with Virtel</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/newsletters/TN201904/TN201904.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="using-vba-macros-with-virtel">
<span id="tn201904"></span><h1>Using VBA Macros with Virtel<a class="headerlink" href="#using-vba-macros-with-virtel" title="Permalink to this heading"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h2>
<p>The following newsletter documents how we can use a VBA macro, driven by MicroSoft Excel, to populate a spreadsheet. From the spreadsheet we drive a Virtel Scenario to obtain a member list of a TSO ISPF Dataset and then populate the spreadsheet with the results. See the Installation section to install the necessary components.</p>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading"></a></h2>
<ol class="arabic">
<li><p>Download the zip package from the Virtel FTP website - vbaexample.zip</p></li>
<li><p>Expand into a directory on your PC - C:MACRO     (This name is coded in the VBA macro)</p></li>
<li><p>Open the macro VBAExample.xlsm with Excel. Note: Enable Macros option when requested.</p></li>
<li><p>Upload the scenario source file VBAExample.vsc to HLQ.VIRTEL.CNTL as member TSTMACRO</p></li>
<li><p>Check the following MACLIB members in HLQ.VIRTEL.SCRNAPI.MACLIB</p>
<blockquote>
<div><p>OPTION$, FOREACH$, COPY$, CASE$, ENDFOR$</p>
<p>Search for any X’44’(è) characters and replace them with X’7C’ (UK/US &#64;). If you do not do this, you will get assembly errors when complying the scenario.</p>
</div></blockquote>
</li>
<li><p>Upload and assemble the TSTMACRO scenario with the ASMSCEN member of the Virtel CNTL library and link the scenario to your HLQ.VIRTEL.LOADLIB.</p></li>
<li><p>Start Virtel</p></li>
<li><p>Check that your CLI 41002 line Entry Point loads scenarios from LOADLIB and not the SCE-DIR.</p>
<blockquote>
<div><p>Go to the Admin Portal and display the CLIHOST Entry Point. Make sure the Directory for scenarios is blank. This will ensure that Virtel loads scenarios from the loadlib.</p>
</div></blockquote>
</li>
</ol>
<p><img alt="image4" src="../../_images/image4130.png" />
<em>Setting the scenario LOAD option in the Entry point</em></p>
<ol class="arabic simple" start="9">
<li><p>Add the transaction CLI-12 to the CLIWHOST Entry point. Transaction CLI-12 is a 3270 based transaction directed towards a TSO session. It uses basic authentication (Security=1) and has an Input Scenario of TSTMACRO.</p></li>
</ol>
<p><img alt="image5" src="../../_images/image5119.png" /></p>
<ol class="arabic simple" start="10">
<li><p>Stop and restart Virtel.</p></li>
</ol>
</section>
<section id="operation">
<h2>Operation<a class="headerlink" href="#operation" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Open the the EXCEL macro VBAExample.xlsm. The following form is presented: -</p></li>
</ol>
<p><img alt="image1" src="../../_images/image1266.png" />
<em>Excel Form</em></p>
<ol class="arabic simple" start="2">
<li><p>The form presents us with several controls that can be used to drive the HTTP requests between the VBA macro and Virtel.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USER</span><span class="p">:</span><span class="o">/</span><span class="n">PASS</span><span class="p">:</span>                     <span class="n">The</span> <span class="n">userid</span> <span class="ow">and</span> <span class="n">password</span><span class="o">.</span>
<span class="n">Show</span> <span class="n">full</span> <span class="n">URL</span><span class="p">:</span>            <span class="n">Revals</span> <span class="n">the</span> <span class="n">URL</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">Virtel</span>
<span class="n">Virtel</span> <span class="n">Host</span> <span class="o">/</span> <span class="n">Port</span><span class="p">:</span>       <span class="n">The</span> <span class="n">target</span> <span class="n">Virtel</span> <span class="n">Host</span> <span class="ow">and</span> <span class="n">Port</span>
<span class="n">DS</span> <span class="n">Name</span><span class="p">:</span>                <span class="n">The</span> <span class="n">Mainframe</span> <span class="n">Dataset</span> <span class="n">name</span>
<span class="n">Additional</span> <span class="n">URL</span> <span class="n">Parms</span><span class="o">.</span>     <span class="n">Keyword</span><span class="p">:</span><span class="n">Value</span> <span class="n">combinations</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">passed</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">URL</span><span class="o">.</span>
<span class="n">Request</span> <span class="n">HTTP</span><span class="p">:</span>           <span class="n">Button</span> <span class="n">to</span> <span class="n">initiate</span> <span class="n">the</span> <span class="n">request</span>
<span class="n">Clear</span> <span class="n">Results</span><span class="p">:</span>          <span class="n">Clear</span> <span class="n">the</span> <span class="n">template</span> <span class="n">result</span> <span class="n">area</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Fill in the required details:-</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">USER</span><span class="p">:</span>             <span class="n">Your</span> <span class="n">userid</span>
<span class="n">PASS</span><span class="p">:</span>             <span class="n">Your</span> <span class="n">password</span>
<span class="n">Virtel</span> <span class="n">Host</span><span class="p">:</span>      <span class="n">IP</span> <span class="n">address</span> <span class="n">of</span> <span class="n">Virtel</span>
<span class="n">Virtel</span> <span class="n">Port</span><span class="p">:</span>      <span class="mi">41002</span>
<span class="n">DS</span> <span class="n">Name</span><span class="p">:</span>          <span class="n">Name</span> <span class="n">of</span> <span class="n">PDS</span> <span class="n">to</span> <span class="nb">list</span>
</pre></div>
</div>
<p>From these details, the VBA macro will generate a URL that will be used to initiate the TSTMACRO transaction. The generated URL looks like.</p>
<p><img alt="image2" src="../../_images/image2149.png" /></p>
<p><em>URL genereted from the EXCEL macro</em></p>
<ol class="arabic simple" start="4">
<li><p>Press the HTTP request button to initiate the transaction. After the transaction has completed the form will be populated with a member list. The final results look like: -</p></li>
</ol>
<p><img alt="image3" src="../../_images/image3139.png" /></p>
</section>
<section id="appendix-a">
<h2>Appendix A<a class="headerlink" href="#appendix-a" title="Permalink to this heading"></a></h2>
<section id="vba-example-scenario">
<h3>VBA Example Scenario<a class="headerlink" href="#vba-example-scenario" title="Permalink to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TSTMACRO SCREENS APPL=TSTMACRO
*######################################################################
*##                         INPUT SCENARIO                           ##
*######################################################################
*
   SCENARIO INPUT
   DEBUG$ TRACE,SCENARIO
*
   COPY$ INPUT-TO-VARIABLE,FIELD=&#39;userName&#39;,VAR=&#39;userName&#39;
   IF$   NOT-FOUND,THEN=PARAM_ERR_USER
   COPY$ INPUT-TO-VARIABLE,FIELD=&#39;password&#39;,VAR=&#39;password&#39;
   IF$   NOT-FOUND,THEN=PARAM_ERR_PWD
   COPY$ INPUT-TO-VARIABLE,FIELD=&#39;dsname&#39;,VAR=&#39;dsname&#39;
   IF$   NOT-FOUND,THEN=PARAM_ERR_DSNAME,ELSE=LOGON
*
PARAM_ERR_USER EQU *
   COPY$ VALUE-TO-VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
         VALUE=&#39;Missing required parameter (userName)&#39;

   GOTO$ ERRORMSG
*
PARAM_ERR_PWD EQU   *
   COPY$ VALUE-TO-VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
         VALUE=&#39;Missing required parameter (password)&#39;
   GOTO$ ERRORMSG
*
PARAM_ERR_DSNAME EQU   *
   COPY$ VALUE-TO-VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
         VALUE=&#39;Missing required parameter (dsname)&#39;
   GOTO$ ERRORMSG
*
LOGON    EQU   *
   ERROR$ 0,&#39;--- LOGON &#39;
*
   CASE$ (01,12,12),                                             *
         (EQ,&#39;ENTER USERID&#39;,DOUSN)
*
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;Not (UserID Logon) Screen&#39;,    *
         VAR=ErrorMsg,TYPE=REPLACE
   GOTO$ ERRORMSG_WITH_SCREEN
*
DOUSN    EQU   *
   ERROR$ 0,&#39;--- DOUSN&#39;
*
   ERROR$ 0,&#39;userName=&#39;,&#39;*userName&#39;
   COPY$ VARIABLE-TO-SCREEN,VAR=&#39;userName&#39;,                      *
         SCREEN=(2,1,7),TYPE=ERASE-FIELD
   ACTION$  TO-APPLICATION,KEY=7D,                               *
         AND=(PROCESS-RESPONSE)
*
   IF$ (01,34,11),                                               *
         EQ=&#39;TSO/E LOGON&#39;,                                       *
         THEN=DOPASS
*
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;Not (TSO Logon) Screen&#39;,       *
         VAR=ErrorMsg,TYPE=REPLACE
   GOTO$ ERRORMSG_WITH_SCREEN
*
DOPASS   EQU   *
   ERROR$ 0,&#39;--- DOPASS&#39;
*
   ERROR$ 0,&#39;password=&#39;,&#39;*password&#39;
   COPY$ VARIABLE-TO-SCREEN,VAR=&#39;password&#39;,                      *
         SCREEN=(8,20,8),TYPE=ERASE-FIELD
DOISPF   LABEL$
   ACTION$  TO-APPLICATION,KEY=7D,                               *
         AND=(WAIT,&#39;ispf&#39;),                                      *
         MAXTIME=500
*
   ERROR$ 0,&#39;Look for ISPF in line 10&#39;
   IF$ (10,2,4),                                                 *
         EQ=&#39;ispf&#39;,                                              *
         THEN=PASSDONE
   ERROR$ 0,&#39;Look for ISPF in line 11&#39;
   IF$ (11,2,4),                                                 *
         EQ=&#39;ispf&#39;,                                              *
         THEN=PASSDONE
   ERROR$ 0,&#39;Look for ISPF in line 12&#39;
   IF$ (12,2,4),                                                 *
         EQ=&#39;ispf&#39;,                                              *
         THEN=PASSDONE
   ERROR$ 0,&#39;Look for ISPF in line 13&#39;
   IF$ (13,2,4),                                                 *
         EQ=&#39;ispf&#39;,                                              *
         THEN=PASSDONE
*
* Check for common login errors
*
   IF$ (2,12,17),                                                *
         EQ=&#39;PASSWORD NOT AUTH&#39;,                                 *
         THEN=LOGON_BADPASS
   IF$ (2,12,6),                                                 *
         EQ=&#39;Userid&#39;,                                            *
         THEN=LOGON_BADUSER_MAYBE
*
* Generic login error message
*
LOGON_GENERIC EQU *
   COPY$ VALUE-TO-VARIABLE,VAR=&#39;ErrorMsg&#39;,TYPE=REPLACE,          *
         VALUE=&#39;ISPF screen not found (Is the user logged in?)&#39;
   GOTO$ ERRORMSG_WITH_SCREEN
*
LOGON_BADUSER_MAYBE EQU *
   IF$ (2,27,8),                                                 *
         EQ=&#39;not auth&#39;,                                          *
         THEN=LOGON_BADUSER,                                     *
         ELSE=LOGON_GENERIC
*
* Invalid User
*
LOGON_BADUSER EQU *
   COPY$ VALUE-TO-VARIABLE,VAR=&#39;ErrorMsg&#39;,TYPE=REPLACE,          *
         VALUE=&#39;Login failed (Invalid User)&#39;
   GOTO$ ERRORMSG_WITH_SCREEN
*
* Invalid Password
*
LOGON_BADPASS EQU *
   COPY$ VALUE-TO-VARIABLE,VAR=&#39;ErrorMsg&#39;,TYPE=REPLACE,          *
         VALUE=&#39;Login failed (Invalid Password)&#39;
   GOTO$ ERRORMSG_WITH_SCREEN
*
PASSDONE EQU   *
   ERROR$ 0,&#39;--- PASSDONE&#39;
*
   ACTION$  TO-APPLICATION,KEY=7D,                               *
         AND=(PROCESS-RESPONSE)
   IF$ (3,29,12),                                                *
         EQ=&#39;ISPF Primary&#39;,                                      *
         THEN=DOOPTION
*
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;Not (Primary Menu) screen&#39;,    *
         VAR=ErrorMsg,TYPE=REPLACE
   GOTO$ ERRORMSG_WITH_SCREEN
*
DOOPTION EQU *
*
   ERROR$ 0,&#39;--- DOOPTION&#39;
*
   ERROR$ 0,&#39;Sending (=3.4)&#39;
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;=3.4&#39;,                         *
         VAR=&#39;input&#39;,TYPE=REPLACE
   COPY$ VARIABLE-TO-SCREEN,VAR=&#39;input&#39;,                         *
         SCREEN=(4,40,4),TYPE=ERASE-FIELD
   ACTION$ TO-APPLICATION,KEY=7D,                                *
         AND=(PROCESS-RESPONSE)
   IF$ (3,30,13),                                                *
         EQ=&#39;Data Set List&#39;,                                     *
         THEN=DODATASET
*
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;Not (DataSet Menu) screen&#39;,    *
         VAR=ErrorMsg,TYPE=REPLACE
   GOTO$ ERRORMSG_WITH_SCREEN
*
DODATASET EQU *
*
   ERROR$ 0,&#39;--- DODATASET&#39;
*
   ERROR$ 0,&#39;Sending Dsname (&#39;,&#39;*dsname&#39;,&#39;)&#39;
   COPY$ VARIABLE-TO-SCREEN,VAR=&#39;dsname&#39;,                        *
         SCREEN=(10,24,46),TYPE=ERASE-FIELD
   ACTION$ TO-APPLICATION,KEY=7D,                                *
         AND=(PROCESS-RESPONSE)
   IF$ (3,16,13),                                                *
         EQ=&#39;Sets Matching&#39;,                                     *
         THEN=DOCONTENT
*
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;Not (DataSet Match) screen&#39;,   *
         VAR=ErrorMsg,TYPE=REPLACE
   GOTO$ ERRORMSG_WITH_SCREEN
*
DOCONTENT EQU *
*
   ERROR$ 0,&#39;--- DOCONTENT&#39;
*
   ERROR$ 0,&#39;Sending (E)&#39;
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;e&#39;,VAR=&#39;input&#39;,TYPE=REPLACE

   COPY$ VARIABLE-TO-SCREEN,VAR=&#39;input&#39;,                         *
         SCREEN=(8,28,1),TYPE=ERASE-FIELD
   ACTION$ TO-APPLICATION,KEY=7D,                                *
         AND=(PROCESS-RESPONSE)
*
   COPY$ SCREEN-TO-VARIABLE,SCREEN=(06,12,69,17),VAR=&#39;lines&#39;,    X
         TYPE=REPLACE
   ERROR$ 0,&#39;Setting lines &#39;,&#39;*lines&#39;


   COPY$ VALUE-TO-VARIABLE,VAR=&#39;response&#39;,VALUE=&#39;OK:&#39;,           X
         TYPE=REPLACE
   GOTO$ APPEND_SCREEN
*
LOGOFF   EQU   *
   ERROR$ 0,&#39;--- DOLOGOFF&#39;
*
   CASE$ (04,02,07),(EQ,&#39;Command&#39;,DOLOGOFF)
   ERROR$ 0,&#39;Not logged - Skipping logoff&#39;
   GOTO$ RETURN_RESPONSE
*
DOLOGOFF LABEL$
   ERROR$ 0,&#39;Sending (=X)&#39;
   PERFORM$ TRACE
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;=X&#39;,                           *
         VAR=&#39;clear&#39;,TYPE=REPLACE
   COPY$ VARIABLE-TO-SCREEN,VAR=&#39;clear&#39;,                         *
         SCREEN=(4,40,2),TYPE=ERASE-FIELD
   ACTION$  TO-APPLICATION,KEY=7D,                               *
         AND=(WAIT,&#39;READY&#39;),                                     *
         MAXTIME=500
*
   ERROR$ 0,&#39;Sending (LOGOFF)&#39;
   PERFORM$ TRACE
   COPY$ VALUE-TO-VARIABLE,VALUE=&#39;LOGOFF&#39;,                       *
         VAR=&#39;logoff&#39;,TYPE=REPLACE
   COPY$ VARIABLE-TO-SCREEN,VAR=&#39;logoff&#39;,                        *
         SCREEN=(2,2,6),TYPE=ERASE-FIELD
   ACTION$  TO-APPLICATION,KEY=7D,                               *
         AND=(WAIT,&#39;LOGGED OFF&#39;),                                *
         MAXTIME=5000
   PERFORM$ TRACE
*
   ERROR$ 0,&#39;User Logged Off&#39;
   GOTO$ RETURN_RESPONSE
*
*
*
*######################################################################
*##                          H E L P E R S                           ##
*######################################################################
*
ERRORMSG EQU   *
   ERROR$ 0,&#39;*ErrorMsg&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,TYPE=REPLACE,           *
         LIST=(&#39;KO:&#39;,&#39;*ErrorMsg&#39;)
   GOTO$ RETURN_RESPONSE
*
ERRORMSG_WITH_SCREEN EQU *
   ERROR$ 0,&#39;*ErrorMsg&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,TYPE=REPLACE,           *
         LIST=(&#39;KO:&#39;,&#39;*ErrorMsg&#39;)
   COPY$ VALUE-TO-VARIABLE,VAR=&#39;response&#39;,VALUE=&#39;(*SCREEN*)&#39;
*
APPEND_SCREEN  EQU *
*
**Only 17 lines were read
*
   ERROR$ 0,&#39;Setting screen to response&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;01:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;02:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;03:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;04:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;05:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;06:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;07:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;08:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;09:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;10:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;11:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;12:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;13:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;14:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;15:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;16:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
   COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,LIST=(&#39;17:&#39;,&#39;*lines&#39;)
   POP$ FIRST-VALUE-OF,VAR=&#39;lines&#39;
*
LOOP1    FOREACH$ VALUE-IN-VARIABLE,VAR=&#39;response&#39;
   COPY$ VARIABLE-TO-VARIABLE,VAR=(&#39;response&#39;,&#39;VAR2&#39;),           X
         FOREACH=LOOP1,TYPE=REPLACE
         ENDFOR$ LOOP1

   GOTO$ LOGOFF
*
RETURN_RESPONSE EQU *
   ERROR$ 0,&#39;Returning response&#39;
   CONVERT$ EBCDIC-TO-ASCII,VAR=&#39;response&#39;,TABLE=&#39;IBM1147&#39;
   SEND$ AS-ANSWER,VAR=&#39;response&#39;,TYPE=&#39;text/plain&#39;,             *
         EXPIRES=IMMEDIATELY
   DEBUG$ NOTRACE,SCENARIO
*
   SCENARIO END
*
*######################################################################
*##                        OUTPUT SCENARIO                           ##
*######################################################################
*
   SCENARIO OUTPUT
   SCENARIO END
*
*****************
***   TRACE   ***
*****************
*
TRACE    SCENARIO SUBROUTINE
*
   COPY$ VALUE-TO-VARIABLE,VAR=&#39;ruler1&#39;,                         X
         VALUE=&#39;---  0---|--- 10---|--- 20---|--- 30---|--- 40---X
         |--- 50---|--- 60---|--- 70---|--- 80---|&#39;,             X
         TYPE=REPLACE
   COPY$ VALUE-TO-VARIABLE,VAR=&#39;ruler2&#39;,                         X
         VALUE=&#39;123456789|123456789|123456789|123456789|123456789X
         |123456789|123456789|123456789|123456789|&#39;,             X
         TYPE=REPLACE
   ERROR$ 0,&#39;          &#39;,&#39;*ruler1&#39;
   ERROR$ 0,&#39;          &#39;,&#39;*ruler2&#39;

LOOP1    FOREACH$ VALUE-IN-SCREEN,SCREEN=(1,1,80,24)
   COPY$ SCREEN-TO-VARIABLE,SCREEN=(=,01,80),VAR=&#39;screenL&#39;,      X
         TYPE=REPLACE
   COPY$ SYSTEM-TO-VARIABLE,VAR=&#39;L1&#39;,LENGTH=2,                   *
         FIELD=(VALUE-OF,CURRENT-LINE),TYPE=REPLACE
   ERROR$ 0,&#39;line &#39;,&#39;*L1&#39;,&#39;== &#39;,&#39;*screenL&#39;
   ENDFOR$ LOOP1
*
ENDTRACE LABEL$
   POP$ VAR=&#39;screenL&#39;
   SCENARIO END
   SCRNEND
*
   END
</pre></div>
</div>
</section>
</section>
<section id="appendix-b">
<h2>Appendix B<a class="headerlink" href="#appendix-b" title="Permalink to this heading"></a></h2>
<section id="vba-macro">
<h3>VBA Macro<a class="headerlink" href="#vba-macro" title="Permalink to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&#39;==========================================================================
&#39;==========================================================================
&#39;
&#39;   Top-level MACROS for Excel
&#39;
&#39;==========================================================================
&#39;==========================================================================

&#39; - MACRO -
&#39; &gt; Performs a POST HTTP request on the generated URL,
&#39; &gt; Extracts data from the received content (if successful),
&#39; &gt; Injects the extracted data into the sheet &#39;output&#39; cells
&#39;
Sub ProcessHTTP()
      Dim baseURL As String
      Dim prms As String
      Dim body As String
      Dim url As String
      Dim content As String
      Dim usrName As String
      Dim usrPass As String

      Call ResetResults
      Call ClearScreen

      &#39; Gather miscellaneous pieces of information from the active sheet
      usrName = ActiveSheet.Range(g_userNameRange).Value
      usrPass = ActiveSheet.Range(g_userPassRange).Value
      baseURL = buildBaseUrl(g_baseUrl)
      prms = buildUrlParams(g_urlParamsRange)
      url = buildURL(baseURL, prms)
      body = &quot;&quot;

      &#39; Send the HTTP request, and get back the received content
      content = sendHttpRequest(url, , body, usrName, usrPass)

      &#39; Handle the HTTP response if no error occured
      If (content &lt;&gt; &quot;&quot;) Then
            handleHttpResponse (content)
      End If
End Sub


&#39; - MACRO -
&#39; Clear the result cells
&#39;
Sub ResetResults()
      Call clearCells(g_responseRange, g_responseCols)
End Sub


&#39; - MACRO - [DEBUG] -
&#39; Displays the generated URL
&#39;
Sub ShowURL()

      Dim url As String
      Dim res As String

      url = buildURL(buildBaseUrl(g_baseUrl), buildUrlParams(g_urlParamsRange))
      res = &quot;The generated URL is :&quot; &amp; vbCrLf &amp; vbCrLf &amp; &quot;[&quot; &amp; url &amp; &quot;]&quot;
      MsgBox res
End Sub

&#39;=============================================================================
&#39;=============================================================================
&#39;
&#39;   Functions and subs
&#39;
&#39;=============================================================================
&#39;=============================================================================

&#39; Extract the meaningful data lines from the received body, and store them into
&#39; the output lines array. This array size is dynamically adjusted to hold any amount of entries.
&#39; The last entry in this array is always followed by an empty marker entry.
&#39;
Function extractDataFromResponse(ByVal content As String, ByRef lines() As String) As Long

      ReDim lines(17)
      Dim nbLines As Long
      Dim startIdx As Long
      Dim nextIdx As Long
      Dim stopIdx As Long
      Dim line As String

      startIdx = 4
      nbLines = 0

      Do
            line = Trim(Mid(content, startIdx, startIdx + 69))
            lines(nbLines) = line
            nbLines = nbLines + 1
            startIdx = startIdx + 69 + 3
      Loop While (nbLines &lt; 17)

      extractDataFromResponse = nbLines
End Function


&#39; Perform a synchronous HTTP request on the specified URL (using the specified body)
&#39; If an error occurs, this function returns an empty string.
&#39; Otherwise, it returns the body as recieved from the host.
&#39;
Function sendHttpRequest(ByVal url As String, _
      Optional ByVal mode As String = &quot;POST&quot;, _
      Optional ByVal body As String = &quot;&quot;, _
      Optional ByVal userName As String = &quot;&quot;, _
      Optional ByVal password As String = &quot;&quot;) As String

      If (g_DEBUG_IN) Then
            Call MsgBox(url &amp; vbCrLf &amp; vbCrLf &amp; body, vbOKOnly, &quot;HTTP Request&quot;)
      End If

      Dim http As Object
      Set http = CreateObject(&quot;MSXML2.XMLHTTP&quot;)

      http.Open mode, url, False, userName, password
      http.setRequestHeader &quot;User-Agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)&quot;
      &#39;   http.setRequestHeader &quot;Content-type&quot;, &quot;application/x-www-form-urlencoded&quot;
      http.setRequestHeader &quot;Content-type&quot;, &quot;text/plain&quot;
      http.Send (body)

      sendHttpRequest = validateHttpResponse(http)

      If (g_DEBUG_OUT And (sendHttpRequest &lt;&gt; &quot;&quot;)) Then
            Dim size As Long
            size = Len(sendHttpRequest)
            Call MsgBox(sendHttpRequest, , &quot;SUCCESS - Received &quot; &amp; size &amp; &quot; bytes&quot;)
      End If
End Function


&#39; Returns eihter an empty string if the HTTP response status is not 200 (and display the error message),
&#39; or the received content otherwise.
&#39;
Function validateHttpResponse(http As Object) As String

      Dim text As String
      Dim resText As String

      Call saveText(g_TRACE_FILE, http.responseText)

      resText = saveScreenAndExtractText(g_SCREEN_FILE, http.responseText)

      text = getHttpErrorText(http)
      If (text &lt;&gt; &quot;&quot;) Then
            text = text &amp; vbCrLf &amp; &quot;_____________________________________&quot; &amp; vbCrLf &amp; http.responseText
            MsgBox text, , &quot;HTTP Request FAILED&quot;
            validateHttpResponse = &quot;&quot;
            Exit Function
      End If

      text = resText
      If (Left(text, 3) = &quot;OK:&quot;) Then
            text = Mid(text, 4)
            validateHttpResponse = text
            Exit Function
      End If

      If (Left(text, 3) = &quot;KO:&quot;) Then
            text = &quot;Applicative Error :&quot; &amp; vbCrLf &amp; vbCrLf &amp; Mid(text, 4)
      Else
            text = text &amp; vbCrLf &amp; &quot;_____________________________________&quot; &amp; vbCrLf &amp; resText
      End If

      MsgBox text, , &quot;Request Failure&quot;
      validateHttpResponse = &quot;&quot;
End Function

&#39; Perform a synchronous HTTP request on the specified URL (using the specified body)
&#39; If an error occurs, this function returns an empty string.
&#39; Otherwise, it returns the body as recieved from the host.
&#39;
Function handleHttpResponse(ByVal content As String) As Boolean

      Dim lines() As String
      &#39;    Dim line As String
      Dim cell As Range
      Dim idx As Long
      Dim nbLines As Long

      nbLines = extractDataFromResponse(content, lines)

      For Each cell In ActiveSheet.Range(g_responseRange).cells
      &#39;     line = lines(idx)
            If (idx = nbLines) Then Exit For
            Call injectResponseLine(cell, lines(idx))
      &#39;     cell.Value = line
            idx = idx + 1
      Next
      handleHttpResponse = True   &#39; successful
End Function


Sub injectResponseLine(ByVal cell As Range, line As String)
      Dim col As Long
      Dim row As Long
      row = cell.row
      col = cell.Column

      ActiveSheet.cells(row, col + 0).Value = RTrim(Mid(line, 1, 8))               &#39; Name
      ActiveSheet.cells(row, col + 2).Value = LTrim(Mid(line, 20, 8))              &#39; Size
      ActiveSheet.cells(row, col + 3).Value = RTrim(Mid(line, 30, 11))             &#39; Created
      ActiveSheet.cells(row, col + 4).Value = RTrim(Mid(line, 44, 18))             &#39; Changed
      ActiveSheet.cells(row, col + 5).Value = RTrim(Mid(line, 63, 7))              &#39; ID
End Sub


&#39; Extract the error text from an HTTP object.
&#39;

Function getHttpErrorText(http As Object) As String
      If (http.Status = 200) Then &#39; Request successful
            getHttpErrorText = &quot;&quot;
            Exit Function
      End If
      getHttpErrorText = &quot;Status code : &quot; &amp; http.Status &amp; vbCrLf _
               &amp; &quot;Status text : &quot; &amp; http.statusText
End Function

&#39; Append the User/Pass/DSName params to the provided base URL
&#39;
&#39; TODO : Add some HTML-escaping on the extracted value
&#39;

Function buildBaseUrl(baseURL As String) As String
      Dim url As String
      Dim host As String
      Dim port As String

      host = LTrim(RTrim(ActiveSheet.Range(g_virtelHostRange).Value))
      port = LTrim(RTrim(ActiveSheet.Range(g_virtelPortRange).Value))

      url = &quot;http://&quot; &amp; host &amp; &quot;:&quot; &amp; port &amp; baseURL

      If (InStr(1, baseURL, &quot;?&quot;) &lt; 1) Then
            url = url &amp; &quot;?&quot;
      Else
            url = url &amp; &quot;&amp;&quot;
      End If

      url = url &amp; &quot;userName=&quot; &amp; LTrim(RTrim(ActiveSheet.Range(g_userNameRange).Value))
      url = url &amp; &quot;&amp;password=&quot; &amp; LTrim(RTrim(ActiveSheet.Range(g_userPassRange).Value))
      url = url &amp; &quot;&amp;dsname=&quot; &amp; LTrim(RTrim(ActiveSheet.Range(g_DSNameRange).Value))
      buildBaseUrl = url
End Function


&#39; Extract the &#39;URL params&#39; from the active sheet, in the specified cells range,
&#39; and return them as an URL parameters string.
&#39; The parameters extraction stops when the first empty name&#39;s cell is encountered.
&#39;
&#39; TODO : Add some HTML-escaping on the extracted value
&#39;
Function buildUrlParams(paramsRange As String) As String
      Dim cells As Variant
      Dim res As String, prmName As String
      Dim idx As Long
      Dim sep As String

      cells = ActiveSheet.Range(paramsRange).Value

      For idx = LBound(cells, 1) To UBound(cells, 1)
            prmName = cells(idx, 1)
            If (prmName = &quot;&quot;) Then Exit For
            res = res &amp; sep &amp; prmName &amp; &quot;=&quot; &amp; cells(idx, 2)
            sep = &quot;&amp;&quot;
      Next
      buildUrlParams = res
End Function


&#39; Merges a base URL and an (optionnal) parameters into a full URL address.
&#39;
Function buildURL(ByVal baseURL As String, Optional ByVal params As String = &quot;&quot;) As String

      Dim separator As String
      If (params &lt;&gt; &quot;&quot;) Then
            separator = &quot;?&quot;
      &#39; Do not use &#39;?&#39; if it is already found in the base URL (in such a case, use &#39;&amp;&#39; instead)
      If (InStr(baseURL, &quot;?&quot;) &gt; 0) Then separator = &quot;&amp;&quot;
            buildURL = baseURL &amp; separator &amp; params
      Else
            buildURL = baseURL
      End If
End Function

&#39; Save some text into the specified file.
&#39;
Private Sub saveTextOld(ByVal path As String, ByVal content As String)
      On Error GoTo saveTextError
      Dim fso As Object
      Dim file As Object
      Set fso = CreateObject(&quot;Scripting.FileSystemObject&quot;)
      Set file = fso.opentextfile(path, 2, True)
      file.Write content
      file.Close
      Exit Sub

saveTextError:
      On Error GoTo 0
      MsgBox Err.Number &amp; vbLf &amp; Err.Description, &quot;Trace file saving error&quot;
End Sub

Private Sub saveText(ByVal path As String, ByVal content As String)
      On Error GoTo saveTextError
      Dim strFile_Path As String
      strFile_Path = path
      Open strFile_Path For Append As #1
      Write #1, Now() &amp; &quot; : &quot; &amp; content
      Close #1
Exit Sub

saveTextError:
      On Error GoTo 0
      MsgBox Err.Number &amp; vbLf &amp; Err.Description, &quot;Trace file saving error&quot;
End Sub

Private Function saveScreenAndExtractText(ByVal path As String, ByVal content As String) As String
      Dim idx As Long
      idx = InStr(1, content, g_ScreenTag)
      If (idx &lt; 1) Then
      &#39; The response does not contain any screen dump
            saveScreenAndExtractText = content
            Exit Function
      End If

      saveScreenAndExtractText = Left(content, idx - 1)

      If (Left(content, 3) = &quot;KO:&quot;) Then
            Sheets(2).Range(g_ScreenMsgRange).Interior.Color = RGB(255, 255, 64)
            Sheets(2).Range(g_ScreenMsgRange).Value = &quot;  &quot; &amp; Mid(saveScreenAndExtractText, 4)
      End If

      Dim scrData As String
      Dim i As Long
      Dim line As String

      &#39; Expected format is:
      &#39; (*SCREEN*)#01:&lt;80 bytes&gt;#02:&lt;80 bytes&gt;...#24:&lt;80 bytes&gt;

      idx = idx + Len(g_ScreenTag) + 4

      For i = 0 To 23
            line = Mid(content, idx + (i * 84), 80)
            Sheets(2).cells(i + g_ScreenRow, g_ScreenColumn).Value = line
            scrData = scrData &amp; line &amp; vbCrLf
      Next

      Sheets(2).Select
      Sheets(2).Range(g_ScreenMsgRange).Select

      &#39; Save the screen content into the specified trace file
      Call saveText(path, scrData)
End Function

Private Sub ClearScreen()
      Dim i As Integer
      For i = 0 To 23
            Sheets(2).cells(i + g_ScreenRow, g_ScreenColumn).ClearContents
      Next
      Sheets(2).Range(g_ScreenMsgRange).ClearContents
      Sheets(2).Range(g_ScreenMsgRange).Interior.Color = RGB(255, 255, 255)
End Sub

&#39; Clear the specified range of cells
&#39;
Sub clearCells(ByVal targetRange As String, Optional ByVal cols As Long = 1)
      Dim cell As Range
      For Each cell In ActiveSheet.Range(targetRange).cells
            cell.ClearContents
            If (cols &gt; 1) Then
                  Dim c As Long
                  For c = 2 To cols
                        cells(cell.row, cell.Column + c - 1).ClearContents
                  Next
            End If
      Next
End Sub
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Syspertec. All rights reserved.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>