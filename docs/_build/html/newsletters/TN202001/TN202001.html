

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Converting a VBA macro &mdash; Virtel 9 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Virtel
          

          
            
            <img src="../../_static/logo_virtel_web.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                4.61
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../virtel.html">Virtel Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../newsletters.html">Technical Newsletters</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Virtel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Converting a VBA macro</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/newsletters/TN202001/TN202001.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="converting-a-vba-macro">
<span id="tn202001"></span><h1>Converting a VBA macro<a class="headerlink" href="#converting-a-vba-macro" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this newsletter we discuss how to migrate an EXCELVBA macro(s) to use VIRTEL’s scenario language and perform the same business logic. Currently, the VBA macro uses Attachmate Extra objects to establish a 3270 session and scrape the 3270 buffers. Application navigation, data validation and session management are also performed within the VBA code.  The VBA macro is driven by a EXECL spread sheet with input data fields, buttons and selection list. The idea of this migration is to maintain as much of the ‘business logic’ of the original macro as possible and only replace the 3270 communication processes with equivalent Virtel APIs.</p>
</div>
<div class="section" id="overview-of-the-business-process">
<h2>Overview of the business process<a class="headerlink" href="#overview-of-the-business-process" title="Permalink to this headline">¶</a></h2>
<p>The business process provides extraction of data for the following: -
- Customer Profile
- Loan Accounts
- Deposit Accounts</p>
<p>In this POC, only Customer Profile information is considered. Three environments HOGV,HOGS and HOGL are CICS regions that can be accessed to provide the CICS interface. These interfaces are defined as Virtel transactions, each one accessing a CICS system. Again, this POC accesses the same CICS system. See transactions CLI-13A, CLI-13B and CLI13-C.</p>
</div>
<div class="section" id="virtel-configuration">
<h2>Virtel Configuration<a class="headerlink" href="#virtel-configuration" title="Permalink to this headline">¶</a></h2>
<p>Three transactions are defined to represent the three CICS environments.</p>
<p><img alt="image1" src="../../_images/image1257.png" /></p>
<p>The detail of each transaction is shown below :-</p>
<p><img alt="image2" src="../../_images/image2148.png" /></p>
<p>The current VBA code maintains all of the MVC (model, view, controller) architecture. With the Virtel solution, the model and controller elements are moved to the supporting scenario, SCENPENF, which runs within the Virtel address space. The scenario is shown in Appendix A. The Virtel input scenario, SCENPENF, is associated with each transaction. This scenario now becomes the Model and Controller of the new MVC architecture, with the VBA code now only providing the View component. Navigational and data extraction are now handled by the scenario, whereas before, it was done in the VBA module.</p>
</div>
<div class="section" id="logic-overview">
<h2>Logic overview<a class="headerlink" href="#logic-overview" title="Permalink to this headline">¶</a></h2>
<p>A series of customer numbers is entered manually on the left-hand side. These match up with customer numbers in the CICS application transaction MENU. This application is used to simulate a CICS transaction extracting customer data.  These customer data inquiries are sent to the mainframe via a HTTP requests within VBA using the MSXML2.XMLHTTP object.   A Virtel VBA Class is used to contain all the necessary HTTP code required to support the operation. A Virtel object is created, based upon the Virtel Class, and is used for communicating between the Virtel STC running on the mainframe and the supporting VBA Module.</p>
<p>The first time the VBA module is called, security credentials are obtained through two VBA InputBox calls :-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">userid</span> <span class="o">=</span> <span class="n">InputBox</span><span class="p">(</span><span class="s2">&quot;Enter your mainframe Userid&quot;</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">InputBox</span><span class="p">(</span><span class="s2">&quot;Enter your mainframe Password&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The IP address and PORT information for Virtel are held in two Public Constants at the beginning of the VBA Module 1.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Public</span> <span class="n">Const</span> <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;192.168.170.48&quot;</span><span class="p">,</span> <span class="n">_</span>
            <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;41002&quot;</span>
</pre></div>
</div>
<p>Each time an inquiry is made a HTTP request is sent to Virtel. The request contains all the information needed by the Virtel scenario SCENPENF with the scenario extracting data from the URL. The extracted data is used to perform the following business logic in the Virtel scenario :-</p>
<ul class="simple">
<li>Logon to CICS</li>
<li>Navigate through to the detail Customer Inquiry panel.</li>
<li>Extract Name, Address1 and City from the screen buffer</li>
<li>Create a response in the form of a CSV string :- name; address1; city</li>
<li>Send the response back to the outstanding HTTP request.</li>
</ul>
<p>An example of the URL generated by the VBA Virtel object is below :-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://192.168.170.48:41002/w2h/WEB2AJAX.htm+HOGL?userName=sptholt&amp;password=pw&amp;trans=MENU&amp;custNo=105226
</pre></div>
</div>
<p>The response data returned is in the form of a CSV string containing name, address1 and city. This information is then used to populate a second worksheet, CUPR. The next two diagrams show the input Excel object worksheet 1</p>
<p><img alt="image3" src="../../_images/image3137.png" /></p>
<p>The output Excel worksheet CUPR, is used to display the customer information extracted from the CSV response string. Note that only three fields are populated, those being Name, Address1, and City :-</p>
<p><img alt="image4" src="../../_images/image4131.png" /></p>
</div>
<div class="section" id="menu-legacy-application">
<h2>Menu Legacy Application<a class="headerlink" href="#menu-legacy-application" title="Permalink to this headline">¶</a></h2>
<p>The legacy application that is used to provide the data is a simple CICS invoice system. A sample of the relevant input screens are shown below. First the Master menu.</p>
<p><img alt="image5" src="../../_images/image5119.png" /></p>
<p>Next, the customer inquiry screen : -</p>
<p><img alt="image6" src="../../_images/image6106.png" /></p>
<p>And finally, the customer detail screen.</p>
<p><img alt="image7" src="../../_images/image7120.png" /></p>
<p>It is from this screen that we navigate to within the Virtel scenario and then extract the Name, Address1 and City and return that data to the VBA code which is then used to populate the CUPR work sheet.</p>
</div>
<div class="section" id="overview-of-the-scenpenf-scenario">
<h2>Overview of the SCENPENF scenario<a class="headerlink" href="#overview-of-the-scenpenf-scenario" title="Permalink to this headline">¶</a></h2>
<p>The SCENPENF scenario performs the following functions after establishing a session with the CICS environment.</p>
<p><strong>Entry : [Extract data from URL]</strong></p>
<ol class="arabic simple">
<li>Extract the following fields from the URL and place them into variables: -<ul>
<li>userName   =&gt;      userName</li>
<li>password   =&gt;      password</li>
<li>trans      =&gt;      trans           CICS transaction</li>
<li>custNo     =&gt;      custNo          Customer Number</li>
</ul>
</li>
<li>GoTo LOGON</li>
</ol>
<p><strong>Label:        LOGON  [Sign on processing]</strong></p>
<ol class="arabic simple">
<li>Copy the userName and password into the CICS sign on screen</li>
<li>Send Enter to the CICS application, check application for message DFHCE3549; signOn complete message.</li>
<li>Goto START</li>
</ol>
<p><strong>Label : START [Screen Navigation]</strong></p>
<ol class="arabic simple">
<li>Copy the CICS transaction variable trans to CICS screen.</li>
<li>Send Enter to the CICS application and wait for buffer with characters ‘MENMAP1’</li>
<li>Call DOREGION sub-routine. Test return screen for any errors.</li>
<li>Copy value=’1’ to location in 3270 buffer at line 5, column 27, for a length of 1.</li>
<li>Send Enter to the CICS application and wait for buffer with characters ‘INQMAP3’</li>
<li>Copy the custNo variable into the CICS screen at location row 5, column 27, for a length of 7.</li>
<li>Call GETDATA sub-routine.</li>
<li>Goto SENDMSG</li>
</ol>
<p><strong>Label : SENDMSG {Build OK response message]</strong></p>
<ol class="arabic simple">
<li>Create list variable concatenation string OK: with variable Message</li>
<li>GoTo RETURN_RSP</li>
</ol>
<p><strong>Label : RETURN_RSP [Send Response to browser]</strong></p>
<ol class="arabic simple">
<li>Terminate 3270 session with CICS</li>
<li>Convert response buffer from EBCDIC to ASCII</li>
<li>Send response back to browser.</li>
<li>Disconnect Virtel Session</li>
<li>End scenario</li>
</ol>
<p><strong>Label : GETDATA [Build response buffer from 3270 buffer]</strong></p>
<ol class="arabic simple">
<li>Copy data from screen and place into variables name1, name2, addr1, addr2</li>
<li>Build CSV Message buffer, concatenating variables name2,name1,addr1,addr2 and trim and blanks. String will look like: ‘Lennon,John;Penny Lane;Liverpool’.</li>
<li>Return to call</li>
</ol>
<p><strong>Label : DOREGION [Example of validation and navigation of a 3270 screen  buffer]</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">REGN0</span> <span class="n">EQU</span> <span class="o">*</span>
<span class="n">If</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;6.5 SWIFTSEC&quot;</span> <span class="n">then</span>
<span class="n">REGN1</span>        <span class="n">EQU</span> <span class="o">*</span>
   <span class="n">If</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Opened Sessions&quot;</span> <span class="n">then</span>
      <span class="n">COPY</span> <span class="n">value</span> <span class="s2">&quot;C&quot;</span> <span class="n">to</span> <span class="n">location</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">Send</span> <span class="s2">&quot;Enter&quot;</span> <span class="n">to</span> <span class="n">application</span>
      <span class="n">GOTO</span> <span class="n">REGN1</span>
   <span class="n">Else</span>
      <span class="n">GOTO</span> <span class="n">REGN2</span>
<span class="n">Else</span>
   <span class="n">GOTO</span> <span class="n">REGN3</span>
<span class="n">REGN2</span>        <span class="n">EQU</span> <span class="o">*</span>
   <span class="n">SEND</span> <span class="s2">&quot;PA2&quot;</span> <span class="n">to</span> <span class="n">application</span>
<span class="n">REGN2A</span> <span class="n">EQU</span> <span class="o">*</span>
   <span class="n">If</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Application List&quot;</span> <span class="n">then</span>
      <span class="n">COPY</span> <span class="n">value</span> <span class="s2">&quot;C&quot;</span> <span class="n">to</span> <span class="n">location</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">Send</span> <span class="s2">&quot;Enter&quot;</span> <span class="n">to</span> <span class="n">application</span>
      <span class="n">GOTO</span> <span class="n">REGN2A</span>
   <span class="n">Else</span>
      <span class="n">GOTO</span> <span class="n">REGN4</span>
<span class="n">REGN3</span> <span class="n">EQU</span> <span class="o">*</span>
   <span class="n">SEND</span> <span class="s2">&quot;PA2&quot;</span> <span class="n">to</span> <span class="n">application</span>
   <span class="n">GOTO</span> <span class="n">REGN0</span>
<span class="n">REGN4</span> <span class="n">EQU</span> <span class="o">*</span>
   <span class="n">Return</span> <span class="n">to</span> <span class="n">caller</span>
</pre></div>
</div>
<p><strong>Error handling</strong></p>
<p>The error handling is very basic. For example, invalid credentials and other errors will be reported as a HTML message:-</p>
<p><img alt="image8" src="../../_images/image866.png" /></p>
<p>An invalid customer number will return no data. See 999999 :-</p>
<p><img alt="image9" src="../../_images/image987.png" /></p>
<p>If the CICS system is not available, you will get the following error reported :-</p>
<p><img alt="image10" src="../../_images/image1048.png" /></p>
<p>This error will also occur if you are signed onto CICS with your credentials through another Virtel session.</p>
</div>
<div class="section" id="appendix-a">
<h2>Appendix A<a class="headerlink" href="#appendix-a" title="Permalink to this headline">¶</a></h2>
<div class="section" id="scenario-scenpenf">
<h3>Scenario SCENPENF<a class="headerlink" href="#scenario-scenpenf" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SCENPENF SCREENS APPL=SCENPENF
*######################################################################
*##                         INPUT SCENARIO                           ##
*######################################################################
*
         SCENARIO INPUT
         DEBUG$ TRACE,SCENARIO
         IF$ SESSION-SWITCH,THEN=RESUME
* Look for message DFHCE3520 (Please type your userid)
         IF$  (23,02,09),EQ=&#39;DFHCE3520&#39;,ELSE=EXIT
*
         COPY$ INPUT-TO-VARIABLE,FIELD=&#39;userName&#39;,VAR=&#39;userName&#39;
         IF$   NOT-FOUND,THEN=PARAM_ERR_USER
         COPY$ INPUT-TO-VARIABLE,FIELD=&#39;password&#39;,VAR=&#39;password&#39;
         IF$   NOT-FOUND,THEN=PARAM_ERR_PWD
         COPY$ INPUT-TO-VARIABLE,FIELD=&#39;trans&#39;,VAR=&#39;trans&#39;
         IF$   NOT-FOUND,THEN=PARAM_ERR_TRANS
         COPY$ INPUT-TO-VARIABLE,FIELD=&#39;custNo&#39;,VAR=&#39;custNo&#39;
         IF$   NOT-FOUND,THEN=PARAM_ERR_CUSTNO,ELSE=LOGON
*
PARAM_ERR_USER EQU *
         COPY$ VALUE-TO-VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=&#39;Missing required parameter (userName)&#39;
         GOTO$ ERRORMSG
*
PARAM_ERR_PWD EQU   *
         COPY$ VALUE-TO-VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=&#39;Missing required parameter (password)&#39;
         GOTO$ ERRORMSG
*
PARAM_ERR_TRANS EQU   *
         COPY$ VALUE-TO-VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=&#39;Missing required parameter (trans)&#39;
         GOTO$ ERRORMSG
*
PARAM_ERR_CUSTNO EQU   *
         COPY$ VALUE-TO-VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=&#39;Missing required parameter (custNo)&#39;
         GOTO$ ERRORMSG
*______________________________________________________________________
RESUME   EQU   *
         IF$   (01,01,07),EQ=&#39;APO00PG&#39;,THEN=DOEXIT
         IF$   (22,01,12),EQ=&#39;P3--------P4&#39;,THEN=DOP4
         IF$   (01,02,04),EQ=&#39;MENU&#39;,THEN=DOCLEAR
         IF$   (01,02,01),EQ=&#39;X&#39;,THEN=DOP3
         IF$   (01,01,34),EQ=&#39;MENU123I Error: session terminated&#39;,     x
               THEN=DOEXIT,ELSE=DOP3
         SCENARIO END
*______________________________________________________________________
LOGON    EQU   *
         COPY$ VARIABLE-TO-SCREEN,VAR=&#39;userName&#39;,SCREEN=(10,26,08)
         COPY$ VARIABLE-TO-SCREEN,VAR=&#39;password&#39;,SCREEN=(11,26,08)
*    Send to application
         ACTION$  TO-APPLICATION,KEY=7D
*
*    on message DFHCE3549 (Signon is complete), press CLEAR SCREEN
         IF$   (24,02,09),EQ=&#39;DFHCE3549&#39;,ELSE=EXIT
         ACTION$  TO-APPLICATION,KEY=6D
         GOTO$ START*______________________________________________________________________
SENDMSG  DS   0H
         COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,TYPE=REPLACE,           *
               LIST=(&#39;OK:&#39;,&#39;*Message&#39;)
         GOTO$ RETURN_RSP
*______________________________________________________________________
START    DS   0H
         ERROR$ 0,&#39;--- START&#39;
         COPY$ VARIABLE-TO-SCREEN,VAR=&#39;trans&#39;,SCREEN=(01,01,04)
               ACTION$  TO-APPLICATION,KEY=7D,                         *
               AND=(WAIT,&#39;MENMAP1&#39;)
         PERFORM$ DOREGION
         COPY$ VALUE-TO-SCREEN,VALUE=&#39;1&#39;,SCREEN=(05,17,01)
         ACTION$  TO-APPLICATION,KEY=7D,                               *
               AND=(WAIT,&#39;INQMAP3&#39;)
         COPY$ VARIABLE-TO-SCREEN,VAR=&#39;custNo&#39;,SCREEN=(05,27,07)
         ACTION$  TO-APPLICATION,KEY=7D
         PERFORM$ GETDATA
         GOTO$ SENDMSG
*______________________________________________________________________
DOLOGOFF DS   0H
         PERFORM$ TRACE
         COPY$ VALUE-TO-SCREEN,VALUE=&#39;CESF&#39;,                           *
               SCREEN=(1,1,4),TYPE=ERASE-FIELD
         ACTION$  TO-APPLICATION,KEY=7D,           SEND CESF           *
               AND=(WAIT,&#39;DFHCE3590&#39;),                                 *
               MAXTIME=500
         ACTION$  TO-APPLICATION,KEY=7D            SEND ENTER
         ACTION$ TERMSESS                          KILL SESSION
*
* Send any response back to browser
*
         CONVERT$ EBCDIC-TO-ASCII,VAR=&#39;response&#39;,TABLE=&#39;IBM1147&#39;
         SEND$ AS-ANSWER,VAR=&#39;response&#39;,TYPE=&#39;text/plain&#39;,             *
               EXPIRES=IMMEDIATELY
         DEBUG$ NOTRACE,SCENARIO
         SCENARIO END
*______________________________________________________________________
DOCLEAR  DS   0H
         ERROR$ 0,&#39;--- DOCLEAR&#39;
* Send CLEAR to exit from the application
         ACTION$  TO-APPLICATION,KEY=6D
         GOTO$ RESUME
*______________________________________________________________________
DOP3     DS   0H
         ERROR$ 0,&#39;--- DOP3&#39;
* Send PF3 to go back to previous menu within the application
         ACTION$  TO-APPLICATION,KEY=F3
         GOTO$ RESUME
*______________________________________________________________________
DOP4     DS   0H
         ERROR$ 0,&#39;--- DOP4&#39;
* Send PF4 to exit from the application
         ACTION$  TO-APPLICATION,KEY=F4
         GOTO$ RESUME
*______________________________________________________________________
DOEXIT   DS   0H
         ERROR$ 0,&#39;--- DOEXIT&#39;
* Send CLEAR before starting new transaction
         ACTION$  TO-APPLICATION,KEY=6D
         GOTO$ START
*______________________________________________________________________
EXIT     EQU   *
         ERROR$ 0,&#39;--- EXIT&#39;
         SCENARIO END
*______________________________________________________________________
*
*######################################################################
*##                          H E L P E R S                           ##
*######################################################################
*
ERRORMSG EQU   *
         COPY$ LIST-TO-VARIABLE,VAR=&#39;response&#39;,TYPE=REPLACE,           *
               LIST=(&#39;KO:&#39;,&#39;*ErrorMsg&#39;)
         GOTO$ RETURN_RSP
*______________________________________________________________________
RETURN_RSP  EQU *
         ACTION$ TERMSESS
         CONVERT$ EBCDIC-TO-ASCII,VAR=&#39;response&#39;,TABLE=&#39;IBM1147&#39;
         SEND$ AS-ANSWER,VAR=&#39;response&#39;,TYPE=&#39;text/plain&#39;,             *
               EXPIRES=IMMEDIATELY
         DEBUG$ NOTRACE,SCENARIO
         ERROR$ 0,&#39;--- DISCONNECT&#39;
         ACTION$ DISCONNECT
         SCENARIO END
*
*######################################################################
*##                        OUTPUT SCENARIO                           ##
*######################################################################
*
         SCENARIO OUTPUT
         SCENARIO END
*
*****************
*** GETDATA   ***
*****************
GETDATA  SCENARIO SUBROUTINE
         COPY$ SCREEN-TO-VARIABLE,SCREEN=(07,27,16),VAR=name1,         *
               TYPE=REPLACE
         COPY$ SCREEN-TO-VARIABLE,SCREEN=(08,27,16),VAR=name2,         *
               TYPE=REPLACE
         COPY$ SCREEN-TO-VARIABLE,SCREEN=(09,27,30),VAR=addr1,         *
               TYPE=REPLACE
         COPY$ SCREEN-TO-VARIABLE,SCREEN=(10,27,16),VAR=addr2,         *
               TYPE=REPLACE
         COPY$ LIST-TO-VARIABLE,VAR=&#39;message&#39;,TYPE=REPLACE,            *
               LIST=(&#39;*name2&#39;,&#39;,&#39;,&#39;*name1&#39;,&#39;;&#39;,                        *
               &#39;*addr1&#39;,&#39;;&#39;,&#39;*addr2&#39;),                                 *
               LTRIM=(&#39; &#39;),RTRIM=(&#39; &#39;)
         SCENARIO END
*
*****************
*** DOREGION  ***
*****************
DOREGION SCENARIO SUBROUTINE
REGN0    LABEL$
         IF$   (01,01,12),EQ=&quot;6.5 SWIFTSEC&quot;,ELSE=REGN3
*    loop through Session Selection
REGN1    LABEL$
         IF$   (04,02,17),EQ=&#39;Opened Sessions &#39;,ELSE=REGN2
         COPY$ VALUE-TO-SCREEN,VALUE=&#39;C&#39;,SCREEN=(05,10,01)
         ACTION$  TO-APPLICATION,KEY=7D
         GOTO$ REGN1
*    loop through Application List. Send PA2 first
REGN2    LABEL$
         ACTION$  TO-APPLICATION,KEY=6E
REGN2A   LABEL$
         IF$   (04,02,17),EQ=&#39;Application List &#39;,ELSE=REGN4
         COPY$ VALUE-TO-SCREEN,VALUE=&#39;C&#39;,SCREEN=(05,10,01)
         ACTION$  TO-APPLICATION,KEY=7D
         GOTO$ REGN2A
REGN3    LABEL$
* Send PA2 and start again.
         ACTION$  TO-APPLICATION,KEY=6E
         GOTO$ REGN0
REGN4    LABEL$
         SCENARIO END
*****************
***  TRACE    ***
*****************
TRACE    SCENARIO SUBROUTINE
*
         COPY$ VALUE-TO-VARIABLE,VAR=&#39;ruler1&#39;,                         X
               VALUE=&#39;---  0---|--- 10---|--- 20---|--- 30---|--- 40---X
               |--- 50---|--- 60---|--- 70---|--- 80---|&#39;,             X
               TYPE=REPLACE
         COPY$ VALUE-TO-VARIABLE,VAR=&#39;ruler2&#39;,                         X
               VALUE=&#39;123456789|123456789|123456789|123456789|123456789X
               |123456789|123456789|123456789|123456789|&#39;,             X
               TYPE=REPLACE
         ERROR$ 0,&#39;          &#39;,&#39;*ruler1&#39;
         ERROR$ 0,&#39;          &#39;,&#39;*ruler2&#39;

LOOP1    FOREACH$ VALUE-IN-SCREEN,SCREEN=(1,1,80,24)
         COPY$ SCREEN-TO-VARIABLE,SCREEN=(=,01,80),VAR=&#39;screenL&#39;,      X
               TYPE=REPLACE
         COPY$ SYSTEM-TO-VARIABLE,VAR=&#39;L1&#39;,LENGTH=2,                   *
               FIELD=(VALUE-OF,CURRENT-LINE),TYPE=REPLACE
         ERROR$ 0,&#39;line &#39;,&#39;*L1&#39;,&#39;== &#39;,&#39;*screenL&#39;
         ENDFOR$ LOOP1
*
ENDTRACE LABEL$
         POP$ VAR=&#39;screenL&#39;
         SCENARIO END
         SCRNEND
*
         END
</pre></div>
</div>
</div>
</div>
<div class="section" id="appendix-b">
<h2>Appendix B<a class="headerlink" href="#appendix-b" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sample-of-a-generic-virtel-vba-class">
<h3>Sample of a generic Virtel VBA Class<a class="headerlink" href="#sample-of-a-generic-virtel-vba-class" title="Permalink to this headline">¶</a></h3>
<p>The following is a sample Virtel class that was used in the POC. Note that not all variables, functions, sub-routines are applicable. Some may not be used in the POC or are for debugging purposes only.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Option Explicit

&#39;=============================================================================================
&#39;=============================================================================================&#39;
&#39;   Constants
&#39;
&#39;=============================================================================================
&#39;=============================================================================================

Private Const g_virtelHostRange As String = &quot;F2&quot;            &#39; 1 cell
Private Const g_virtelPortRange As String = &quot;F3&quot;            &#39; 1 cell
Private Const g_userNameRange As String = &quot;C2&quot;              &#39; 1 cell (login user name)
Private Const g_userPassRange As String = &quot;C3&quot;              &#39; 1 cell (login password)
Private Const g_DSNameRange As String = &quot;F5&quot;                &#39; 1 cell (requested DSName)
Private Const g_Environment As String = &quot;D3&quot;                &#39; 1 cell Environment
Private Const g_Profile As String = &quot;D4&quot;                    &#39; 1 cell Profile

Private Const g_urlParamsRange As String = &quot;B10:C1000&quot;      &#39; 2 columns (name/value)
Private Const g_responseRange As String = &quot;F10:F500&quot;
Private Const g_responseCols As Long = 6

Private Const g_baseUrl As String = &quot;/w2h/WEB2AJAX.htm+&quot;

Private Const g_markerEOL As String = &quot;/#&quot;

Private Const g_ScreenTag As String = &quot;(*SCREEN*)&quot;
Private Const g_ScreenColumn As Integer = 2
Private Const g_ScreenRow As Integer = 1
Private Const g_ScreenMsgRange As String = &quot;B26&quot;

Private Const g_DEBUG_IN As Boolean = False
Private Const g_DEBUG_OUT As Boolean = False

Private Const g_TRACE_FILE As String = &quot;C:\Virtel\response.txt&quot;
Private Const g_SCREEN_FILE As String = &quot;C:\Virtel\screen.txt&quot;

&#39;=============================================================================================
&#39;=============================================================================================
&#39;
&#39;   Top-level MACROS for Excel
&#39;
&#39;=============================================================================================
&#39;=============================================================================================

&#39; - MACRO -
&#39; &gt; Performs a POST HTTP request on the generated URL,
&#39; &gt; Returns received content (if successful)
&#39;
Sub ProcessHTTP(usrName As String, usrPass As String, baseURL As String, content As String, message As String, state As Integer, system As String, transaction As String, custNo As String)
   Dim prms As String
   Dim body As String
   Dim url As String


   baseURL = buildBaseUrl(g_baseUrl, usrName, usrPass, system, transaction, custNo)
   url = buildURL(baseURL, prms)
   body = &quot;&quot;

   &#39; Send the HTTP request, and get back the received content
   content = sendHttpRequest(url, , body, usrName, usrPass)
End Sub


&#39; - MACRO - [DEBUG] -
&#39; Displays the generated URL
&#39;
Sub ShowURL()

   Dim url As String
   Dim res As String

   url = buildURL(buildBaseUrl(g_baseUrl), buildUrlParams(g_urlParamsRange))
   res = &quot;The generated URL is :&quot; &amp; vbCrLf &amp; vbCrLf &amp; &quot;[&quot; &amp; url &amp; &quot;]&quot;

   MsgBox res

End Sub


&#39;=============================================================================================
&#39;=============================================================================================
&#39;
&#39;   Functions and subs
&#39;
&#39;=============================================================================================
&#39;=============================================================================================

&#39; Extract the meaningful data lines from the received body, and store them into
&#39; the output lines array. This array size is dynamically adjusted to hold any amount of entries.
&#39; The last entry in this array is always followed by an empty marker entry.
&#39;
Function extractDataFromResponse(ByVal content As String, ByRef lines() As String) As Long

   ReDim lines(17)

   Dim nbLines As Long
   Dim startIdx As Long
   Dim nextIdx As Long
   Dim stopIdx As Long
   Dim line As String

   startIdx = 4
   nbLines = 0

   Do
      line = Trim(Mid(content, startIdx, startIdx + 69))
      lines(nbLines) = line
      nbLines = nbLines + 1
      startIdx = startIdx + 69 + 3

   Loop While (nbLines &lt; 17)

   extractDataFromResponse = nbLines

End Function


&#39; Perform a synchronous HTTP request on the specified URL (using the specified body)
&#39; If an error occurs, this function returns an empty string.
&#39; Otherwise, it returns the body as recieved from the host.
&#39;
Function sendHttpRequest(ByVal url As String, _
                        Optional ByVal mode As String = &quot;POST&quot;, _
                        Optional ByVal body As String = &quot;&quot;, _
                        Optional ByVal userName As String = &quot;&quot;, _
                        Optional ByVal password As String = &quot;&quot;) As String

   If (g_DEBUG_IN) Then
      Call MsgBox(url &amp; vbCrLf &amp; vbCrLf &amp; body, vbOKOnly, &quot;HTTP Request&quot;)
   End If

   Dim http As Object
   Set http = CreateObject(&quot;MSXML2.XMLHTTP&quot;)

   http.Open mode, url, False, userName, password
   http.setRequestHeader &quot;User-Agent&quot;, &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)&quot;
&#39;   http.setRequestHeader &quot;Content-type&quot;, &quot;application/x-www-form-urlencoded&quot;
   http.setRequestHeader &quot;Content-type&quot;, &quot;text/plain&quot;
   http.Send (body)

   sendHttpRequest = validateHttpResponse(http)

   If (g_DEBUG_OUT And (sendHttpRequest &lt;&gt; &quot;&quot;)) Then
      Dim size As Long
      size = Len(sendHttpRequest)
      Call MsgBox(sendHttpRequest, , &quot;SUCCESS - Received &quot; &amp; size &amp; &quot; bytes&quot;)
   End If

End Function


&#39; Returns eihter an empty string if the HTTP response status is not 200 (and display the error message),
&#39; or the received content otherwise.
&#39;
Function validateHttpResponse(http As Object) As String

   Dim text As String
   Dim resText As String

   Call saveText(g_TRACE_FILE, http.responseText)

   resText = saveScreenAndExtractText(g_SCREEN_FILE, http.responseText)

   text = getHttpErrorText(http)
   If (text &lt;&gt; &quot;&quot;) Then
      text = text &amp; vbCrLf &amp; &quot;___________________________&quot; &amp; vbCrLf &amp; http.responseText
      MsgBox text, , &quot;HTTP Request FAILED&quot;
      validateHttpResponse = &quot;&quot;
      Exit Function
   End If

   text = resText
   If (Left(text, 3) = &quot;OK:&quot;) Then
      text = Mid(text, 4)
      validateHttpResponse = text
      Exit Function
   End If

   If (Left(text, 3) = &quot;KO:&quot;) Then
      text = &quot;Applicative Error :&quot; &amp; vbCrLf &amp; vbCrLf &amp; Mid(text, 4)
   Else
      text = text &amp; vbCrLf &amp; &quot;___________________________&quot; &amp; vbCrLf &amp; resText
   End If

   MsgBox text, , &quot;Request Failure&quot;
   validateHttpResponse = &quot;&quot;

End Function


&#39; Perform a synchronous HTTP request on the specified URL (using the specified body)
&#39; If an error occurs, this function returns an empty string.
&#39; Otherwise, it returns the body as recieved from the host.
&#39;
Function handleHttpResponse(ByVal content As String) As Boolean

   Dim lines() As String
&#39;    Dim line As String
   Dim cell As Range
   Dim idx As Long
   Dim nbLines As Long

   nbLines = extractDataFromResponse(content, lines)

   For Each cell In ActiveSheet.Range(g_responseRange).cells
&#39;        line = lines(idx)
      If (idx = nbLines) Then Exit For
      Call injectResponseLine(cell, lines(idx))
&#39;        cell.Value = line
      idx = idx + 1
   Next

   handleHttpResponse = True   &#39; successful

End Function

Sub injectResponseLine(ByVal cell As Range, line As String)

   Dim col As Long
   Dim row As Long
   row = cell.row
   col = cell.Column

   ActiveSheet.cells(row, col + 0).Value = RTrim(Mid(line, 1, 8))               &#39; Name
   ActiveSheet.cells(row, col + 2).Value = LTrim(Mid(line, 20, 8))              &#39; Size
   ActiveSheet.cells(row, col + 3).Value = RTrim(Mid(line, 30, 11))             &#39; Created
   ActiveSheet.cells(row, col + 4).Value = RTrim(Mid(line, 44, 18))             &#39; Changed
   ActiveSheet.cells(row, col + 5).Value = RTrim(Mid(line, 63, 7))              &#39; ID

End Sub


&#39; Extract the error text from an HTTP object.
&#39;
Function getHttpErrorText(http As Object) As String

   If (http.Status = 200) Then &#39; Request successful
      getHttpErrorText = &quot;&quot;
      Exit Function
   End If

   getHttpErrorText = &quot;Status code : &quot; &amp; http.Status &amp; vbCrLf _
                     &amp; &quot;Status text : &quot; &amp; http.statusText
End Function


&#39; Append the User/Pass/DSName params to the provided base URL
&#39;
&#39; TODO : Add some HTML-escaping on the extracted value
&#39;
Function buildBaseUrl(baseURL As String, usrName As String, usrPass As String, system As String, trans As String, custNo As String)

   Dim url As String
   Dim host As String
   Dim port As String

   &#39;-- host = LTrim(RTrim(ActiveSheet.Range(g_virtelHostRange).Value))
   &#39;-- port = LTrim(RTrim(ActiveSheet.Range(g_virtelPortRange).Value))

   url = &quot;http://&quot; &amp; host &amp; &quot;:&quot; &amp; port &amp; baseURL
   url = url &amp; system

   If (InStr(1, baseURL, &quot;?&quot;) &lt; 1) Then
      url = url &amp; &quot;?&quot;
   Else
      url = url &amp; &quot;&amp;&quot;
   End If

   url = url &amp; &quot;userName=&quot; &amp; LTrim(RTrim(usrName))
   url = url &amp; &quot;&amp;password=&quot; &amp; LTrim(RTrim(usrPass))
   url = url &amp; &quot;&amp;trans=&quot; &amp; LTrim(RTrim(trans))
   url = url &amp; &quot;&amp;custNo=&quot; &amp; LTrim(RTrim(custNo))


   buildBaseUrl = url

End Function


&#39; Extract the &#39;URL params&#39; from the active sheet, in the specified cells range,
&#39; and return them as an URL parameters string.
&#39; The parameters extraction stops when the first empty name&#39;s cell is encountered.
&#39;
&#39; TODO : Add some HTML-escaping on the extracted value
&#39;
Function buildUrlParams(paramsRange As String) As String

   Dim cells As Variant
   Dim res As String, prmName As String
   Dim idx As Long
   Dim sep As String

   cells = ActiveSheet.Range(paramsRange).Value

   For idx = LBound(cells, 1) To UBound(cells, 1)
      prmName = cells(idx, 1)
      If (prmName = &quot;&quot;) Then Exit For
      res = res &amp; sep &amp; prmName &amp; &quot;=&quot; &amp; cells(idx, 2)
      sep = &quot;&amp;&quot;
   Next

   buildUrlParams = res

End Function


&#39; Merges a base URL and an (optionnal) parameters into a full URL address.
&#39;
Function buildURL(ByVal baseURL As String, Optional ByVal params As String = &quot;&quot;) As String

   Dim separator As String

   If (params &lt;&gt; &quot;&quot;) Then
      separator = &quot;?&quot;
      &#39; Do not use &#39;?&#39; if it is already found in the base URL (in such a case, use &#39;&amp;&#39; instead)
      If (InStr(baseURL, &quot;?&quot;) &gt; 0) Then separator = &quot;&amp;&quot;
      buildURL = baseURL &amp; separator &amp; params
   Else
      buildURL = baseURL
   End If

End Function


&#39; Save some text into the specified file.
&#39;
Private Sub saveTextOld(ByVal path As String, ByVal content As String)

   On Error GoTo saveTextError

   Dim fso As Object
   Dim file As Object

   Set fso = CreateObject(&quot;Scripting.FileSystemObject&quot;)
   Set file = fso.opentextfile(path, 2, True)
   file.Write content
   file.Close
   Exit Sub

saveTextError:
   On Error GoTo 0
   MsgBox Err.Number &amp; vbLf &amp; Err.Description, &quot;Trace file saving error&quot;

End Sub

Private Sub saveText(ByVal path As String, ByVal content As String)

   On Error GoTo saveTextError
   Dim strFile_Path As String
   strFile_Path = path
   Open strFile_Path For Append As #1
   Write #1, Now() &amp; &quot; : &quot; &amp; content
   Close #1

   Exit Sub

saveTextError:
   On Error GoTo 0
   MsgBox Err.Number &amp; vbLf &amp; Err.Description, &quot;Trace file saving error&quot;

End Sub


Private Function saveScreenAndExtractText(ByVal path As String, ByVal content As String) As String

   Dim idx As Long

   idx = InStr(1, content, g_ScreenTag)
   If (idx &lt; 1) Then
      &#39; The response does not contain any screen dump
      saveScreenAndExtractText = content
      Exit Function
   End If

   saveScreenAndExtractText = Left(content, idx - 1)

   If (Left(content, 3) = &quot;KO:&quot;) Then
      Sheets(2).Range(g_ScreenMsgRange).Interior.Color = RGB(255, 255, 64)
      Sheets(2).Range(g_ScreenMsgRange).Value = &quot;  &quot; &amp; Mid(saveScreenAndExtractText, 4)
   End If

   Dim scrData As String
   Dim i As Long
   Dim line As String

   &#39; Expected format is:
   &#39; (*SCREEN*)#01:&lt;80 bytes&gt;#02:&lt;80 bytes&gt;...#24:&lt;80 bytes&gt;

   idx = idx + Len(g_ScreenTag) + 4

   For i = 0 To 23
      line = Mid(content, idx + (i * 84), 80)
      Sheets(2).cells(i + g_ScreenRow, g_ScreenColumn).Value = line
      scrData = scrData &amp; line &amp; vbCrLf
   Next

   Sheets(2).Select
   Sheets(2).Range(g_ScreenMsgRange).Select

   &#39; Save the screen content into the specified trace file
   Call saveText(path, scrData)

End Function


Private Sub ClearScreen()

   Dim i As Integer
   For i = 0 To 23
      Sheets(2).cells(i + g_ScreenRow, g_ScreenColumn).ClearContents
   Next
   Sheets(2).Range(g_ScreenMsgRange).ClearContents
   Sheets(2).Range(g_ScreenMsgRange).Interior.Color = RGB(255, 255, 255)

End Sub


&#39; Clear the specified range of cells
&#39;
Sub clearCells(ByVal targetRange As String, Optional ByVal cols As Long = 1)

   Dim cell As Range

   For Each cell In ActiveSheet.Range(targetRange).cells
      cell.ClearContents
      If (cols &gt; 1) Then
            Dim c As Long
            For c = 2 To cols
               cells(cell.row, cell.Column + c - 1).ClearContents
            Next
      End If
   Next

End Sub
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017, Syspertec. All rights reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>