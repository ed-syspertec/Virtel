

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Printing PCL files with NodeJS &mdash; Virtel 9 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="What’s new in Virtel 4.57 (July 2017)" href="../TN201706/TN201706     .html" />
    <link rel="prev" title="Virtel Macros" href="../TN201704/TN201704.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Virtel
          

          
            
            <img src="../../../_static/logo_virtel_web.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                4.61
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../virtel.html">Virtel Manuals</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../newsletters.html">Technical Newsletters</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id1">2014</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id2">2015</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id3">2016</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../newsletters.html#id4">2017</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../TN201701/TN201701.html">Protecting business assets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201702/TN201702.html">Protecting Virtel Applications with Shibboleth</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201703/TN201703.html">Passticket support with CA Top Secret</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201704/TN201704.html">Virtel Macros</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Printing PCL files with NodeJS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#appendix-a">Appendix A</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../TN201706/TN201706     .html">What’s new in Virtel 4.57 (July 2017)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201707/tn201707.html">Getting started with Sphinx and ReadTheDocs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201709/TN201709.html">Virtel Batch Maintenance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id5">2018</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id6">2019</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id7">2020</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id8">2021</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Virtel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../newsletters.html">Technical Newsletters</a> &raquo;</li>
        
      <li>Printing PCL files with NodeJS</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/manuals/newsletters/TN201705/TN201705     .rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="printing-pcl-files-with-nodejs">
<span id="tn201705"></span><h1>Printing PCL files with NodeJS<a class="headerlink" href="#printing-pcl-files-with-nodejs" title="Permalink to this headline">¶</a></h1>
<p><strong>Introduction</strong></p>
<p>Because of the security restrictions within the browser environment
Virtel is unable to print directly to a printer – the standard windows
printer dialogue box is not available. The print options available are
restricted compared to other terminal emulators which run outside of a
browser environment. Users like to have the ability to send a print
request to a printer the moment it arrives. With Virtel, when a print
data stream arrives several options are available depending on the type
of Virtel printer receiving the source data stream. For Virtel terminals
designated as type P, these are LU0/3 3270 printers, when a print
request is processed by one of these terminals a new browser window will
open displaying the print data. From within this window the output can
be printed using the standard print feature of the browser.</p>
<p>With Virtel terminals designated as type S, these are considered SCS or
LU type 1 printers. These are normally associated with CICS
applications. When the Virtel terminal processes the print request a
printer ICON appears on the right hand side of the tool bar.</p>
<p><a class="reference internal" href="../../../_images/image147.png"><img alt="image0" src="../../../_images/image147.png" style="width: 6.30000in; height: 3.47500in;" /></a></p>
<p>Figure 1 Virtel Print request</p>
<p>Pressing the Printer ICON initiates the print processing which, if
successful, results in a PCL file being downloaded to the users default
download directory. To print the file the user has to perform some
external function to send the file to a printer. Today, there are
several options or solutions available to the user in initiating this
function. There are a variety of directory watcher products/solutions
available; some are free and some of them can automate printing of
files.</p>
<p>In this newsletter we implement a small directory watcher script which
will send any new PCL files to a designated printer. The script is
written in JavaScript and runs within the NodeJS (<a class="reference external" href="https://nodejs.org">https://nodejs.org</a>)
program. Using this script we can automate the print function so that
PCL files are routed directly to a designated printer, once Virtel has
downloaded the file.</p>
<p><strong>Pre-Installation setup</strong></p>
<p>To use this script certain pre-requisites are required. NodeJS needs to
be installed on your PC and the Windows LPR program must be accessible.
By default, Windows doesn’t install this program. You will need to
ensure that the correct Windows features have been selected and
installed. See below.</p>
<p><a class="reference internal" href="../../../_images/image228.png"><img alt="image1" src="../../../_images/image228.png" style="width: 6.30000in; height: 3.46042in;" /></a></p>
<p>Figure 2 Required Windows features</p>
<p>Validation of these requisites can be done by issuing the following two
commands.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>node –version Determine node is installed and accessible.
lpr The print route program is installed and accessible
</pre></div>
</div>
<p>The following screen capture shows the response from these commands:-</p>
<p><a class="reference internal" href="../../../_images/image325.png"><img alt="image2" src="../../../_images/image325.png" style="width: 6.30000in; height: 3.86389in;" /></a></p>
<p>Figure 3 Validating pre-requisites</p>
<p>Once the pre-requisite software has been installed and validated we can
install the nodeJS script. First create a directory to contain the
script and relevant nodeJS components. In our example we will create a
directory called c:\virtel\VirtelSpooler where we will install the
necessary nodeJS script and bat files. Open a command window in this
directory and type the following command:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span> <span class="n">chokidar</span> <span class="o">--</span><span class="n">save</span> <span class="o">**</span>
</pre></div>
</div>
<p>This will download a bunch of modules required by the Virtel Spooler
script. Next, create a file in the directory called main.js and copy and
paste the script listed in Appendix A.</p>
<p>Now, in the same directory as main.js, create a small bat file called
printPCL.bat. This is also listed Appendix A.</p>
<p>Now we are ready to go!</p>
<p><strong>Starting the Virtel Spooler</strong></p>
<p>The Virtel Spooler script is started with the following commands:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">c</span><span class="p">:</span>\\<span class="n">virtel</span>\\<span class="n">VirtelSpooler</span>
<span class="n">node</span> <span class="n">main</span><span class="o">.</span><span class="n">js</span> <span class="n">myServer</span> <span class="n">myPrinter</span> <span class="n">myDownloadDirectory</span>
</pre></div>
</div>
<p>So, for example, in my installation I use the following commands:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">c</span><span class="p">:</span>\\<span class="n">virtel</span>\\<span class="n">VirtelSpooler</span>
<span class="n">node</span> <span class="n">main</span><span class="o">.</span><span class="n">js</span> <span class="n">CSD</span> <span class="n">KONICA</span>\<span class="n">_Couleur</span>\<span class="n">_C284e</span> <span class="n">d</span><span class="p">:</span>\\<span class="n">downloads</span>
</pre></div>
</div>
<p>With the spooler running and monitory the download directory, I can now
fire off PCL print requests from my CICS program which will be
automatically print on my designated printer. When Virtel downloads the
PCL file to my download directory the Virtel Spooler script will be
notified of the event. The Virtel Spooler program will then send the PCL
file to my designated “server.printer”, in my case
CSD.KONICA_Couleur_C284e. The PCL file will be printed without any
manual intervention.</p>
<p>The Virtel Spooler will issue a message each time it prints a file:-</p>
<p><a class="reference internal" href="../../../_images/image421.png"><img alt="image3" src="../../../_images/image421.png" style="width: 6.30000in; height: 3.21944in;" /></a></p>
<p>Figure 4 Virtel Spooler log</p>
<p>To terminate the Virtel Spooler, issue CTRL-C in the command window.</p>
<p><strong>What can go wrong!</strong></p>
<p>Well quite a lot actually, and it is not always obvious. In my
environment I have tested the Virtel Spooler with Window 7 and Windows
10.</p>
<p><em>I have PCL files in my directory but nothing prints.</em></p>
<p>This is probably because the monitored directory is wrong or the PCL
files have the wrong suffix. The suffix is lower case and must be
“.pcl”.</p>
<p><em>The LPR command is issued but it hangs.</em></p>
<p>This is probably because the print server or printer name are not valid.
Do a test print to your printer and check that:-</p>
<p>The “Computer name:” = the Virtel Spooler server name</p>
<p>The “Share name:” = the Virtel Spooler printer name</p>
<p>The “Data format:” = RAW</p>
<p>Issue a LPR command from a command prompt to make sure that the printer
is printing.</p>
<p><em>The “LPR command is not found or is not executable.”</em></p>
<p>I experienced this problem on one Windows 7 environment despite the fact
that when I executed the LPR command in a command prompt it responded
correctly. It was only when spawning the batch job from the Virtel
Spooler script did this message appear. The quick resolution was to copy
the lpd.exe program from c:\windows\system32 to
c:\virtel\VirtelSpooler. All worked fine after that.</p>
<p><em>I already have nodeJS installed but get errors when running nodeJS main.js.</em></p>
<p>Install a later release of NodeJS.</p>
<div class="section" id="appendix-a">
<h2>Appendix A<a class="headerlink" href="#appendix-a" title="Permalink to this headline">¶</a></h2>
<p><strong>main.js</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/* Virtel PCL Print Spooler.
 * Monitors spool directory and automatically sends PCL file to network printer.
 *
 * npm install chokidar –save
 *
 * To run this script : node main.js PrintServerName PrinterName Directory
 * For Example:-
 *
 * node main.js CSD KONICA\_Couleur\_C284e d:\\downloads
 *
 * References:
 * https://github.com/paulmillr/chokidar
 *
 */

var chokidar = require(&#39;chokidar&#39;);

const printer = process.argv[3], server = process.argv[2];
const spawn = require(&#39;child\_process&#39;).spawn;
var directory = process.argv[4];
directory = directory + &quot;\\*.pcl&quot;;

// Initialize watcher.
var watcher = chokidar.watch(directory, {
  ignored: /(^|[\/\\])\../,
  persistent: true
});

function execBatFile(file) {
  const args = [
    &#39;/c&#39;,
      &#39;printPCL.bat &#39; +
      server + &#39; &#39; +
      printer + &#39; &#39; + file
  ];

const bat = spawn(&#39;cmd.exe&#39;, args);
bat.stdout.on(&#39;data&#39;, (data) =&gt; {
  console.log(data.toString());
});
bat.stderr.on(&#39;data&#39;, (data) =&gt; {
  console.log(data.toString());
});
bat.on(&#39;exit&#39;, (code) =&gt; {
  //console.log(\`Child exited with code ${code}\`);
});
bat.on(&#39;error&#39;, (code) =&gt; {
  console.log(\`Child exited with error code ${code}\`);
});
console.log(&#39;VIRU099I - Batch command executed for &#39; + file);
}
// Add event listeners.
watcher.on(&#39;add&#39;, path =&gt; execBatFile(\`${path}\`));
</pre></div>
</div>
<p><strong>printPCL.bat</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Echo</span> <span class="n">off</span>
<span class="nb">set</span> <span class="n">arg1</span><span class="o">=%</span><span class="mi">1</span>
<span class="nb">set</span> <span class="n">arg2</span><span class="o">=%</span><span class="mi">2</span>
<span class="nb">set</span> <span class="n">arg3</span><span class="o">=%</span><span class="mi">3</span>
<span class="n">echo</span> <span class="n">lpr</span> <span class="o">-</span><span class="n">S</span> <span class="o">%</span><span class="n">arg1</span><span class="o">%</span> <span class="o">-</span><span class="n">P</span> <span class="o">%</span><span class="n">arg2</span><span class="o">%</span> <span class="o">%</span><span class="n">arg3</span><span class="o">%</span>
<span class="n">lpr</span> <span class="o">-</span><span class="n">S</span> <span class="o">%</span><span class="n">arg1</span><span class="o">%</span> <span class="o">-</span><span class="n">P</span> <span class="o">%</span><span class="n">arg2</span><span class="o">%</span> <span class="o">%</span><span class="n">arg3</span><span class="o">%</span>
<span class="k">del</span> <span class="o">%</span><span class="n">arg3</span><span class="o">%</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../TN201706/TN201706     .html" class="btn btn-neutral float-right" title="What’s new in Virtel 4.57 (July 2017)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../TN201704/TN201704.html" class="btn btn-neutral float-left" title="Virtel Macros" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Syspertec. All rights reserved

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>