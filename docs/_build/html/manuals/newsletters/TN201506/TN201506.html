

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>An example of using web services with Virtel Integration &mdash; Virtel 7 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Customising Virtel" href="../TN201507/TN201507.html" />
    <link rel="prev" title="Virtel Macros in Virtel 4.53" href="../TN201505/TN201505.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Virtel
          

          
            
            <img src="../../../_static/logo_virtel_web.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                4.57
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../virtel.html">Virtel Manuals</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../newsletters.html">Technical Newsletters</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id1">2014</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../newsletters.html#id2">2015</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../TN201501/TN201501.html">Dynamic Directory Interface (DDI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201504/TN201504.html">Running multiple instances of Virtel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201505/TN201505.html">Virtel Macros in Virtel 4.53</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">An example of using web services with Virtel Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201507/TN201507.html">Customising Virtel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201515/TN201515.html">Using Virtel as a Secure Single Access Control Point</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201517/TN201517.html">Virtel Chinese Character Language Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201519/TN201519.html">Processing the VTAM USS MSG10 buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201520/TN201520.html">Using the IBM System Logger with Virtel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201522/TN201522.html">What’s new in Virtel 4.55</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id3">2016</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id4">2017</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id5">2018</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id6">2019</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Virtel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../newsletters.html">Technical Newsletters</a> &raquo;</li>
        
      <li>An example of using web services with Virtel Integration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/manuals/newsletters/TN201506/TN201506.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="an-example-of-using-web-services-with-virtel-integration">
<span id="tn201506"></span><h1>An example of using web services with Virtel Integration<a class="headerlink" href="#an-example-of-using-web-services-with-virtel-integration" title="Permalink to this headline">¶</a></h1>
<p>Web services (WS) are one of the foundation blocks of the Services Oriented
Architecture blue print. This blue print forms the basis on which many
of today’s e-commerce infrastructures are built, but what is a web
services? Simply put, web services are discoverable services that are
made available from a business’s web server for web users or other
web-connected programs to use. Client programs or systems interact with
the web service using SOAP (Simple Object Access Protocol) messages,
which are conveyed using the standardized protocols of HTTP with XML
serialization. The support web services or operations, message formats
and data structures supported by a web service are described by an XML
document using Web Service Data Language (WSDL). Web services are
discoverable through UDDI servers or equivalent. UDDI (Universal
Description, Discovery, and Integration) is an XML based registry for
businesses worldwide to list themselves on the Internet. Its ultimate
goal is to streamline online transactions by enabling companies to find
one another on the Web and make their systems interoperable for
e-commerce. Once a web service has been identified it can be used by
exploiting the contents of the published WSDL. When using web services,
message exchange is through the open and standardized SOAP format. As an
example, a program wishing to know the current exchange rate between two
currencies can send a SOAP message request to a web service provider and
the results will be returned in a SOAP message response.</p>
<p>In this newsletter we demonstrate how Virtel can interface between a
legacy batch application and a web service to retrieve the exchange rate
between two currencies. The exchange rate web service is provided by a
web service hosted by <a class="reference external" href="http://www.webservicex.net">www.webservicex.net</a>.</p>
<p>An overview of the service is displayed below.</p>
<p><a class="reference internal" href="../../../_images/image15.jpg"><img alt="image0" src="../../../_images/image15.jpg" style="width: 6.26806in; height: 3.52569in;" /></a></p>
<p><em>Figure 1 - Overview of web services elements.</em></p>
<p>Breaking down the individual actions we can anaylze the components
involved.</p>
<ol class="arabic simple">
<li>Connection to the Virtel Server is through a batch application. In
this case we are using REXX to connect to the Virtel server using
REXX socket fuctions. The batch application runs as a batch task
invoking TCPIP to initialize and connect a socket to VIRTEL. The
batch application sends a URL request to VIRTEL, effectively
emulatiing a browser. The URL request identifies the VIRTEL line,
template and transaction. Virtel is unaware that it is conversing
with a batch program. The following is the JCL that invokes the REXX
batch application.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//LIBS JCLLIB ORDER=SPTHOLT.VIRTEL.REXX
//*
//* LINE 41002 CLIHOST
//* LINE 41102 EDSHOST
//* LINE 41001 W2HHOST
//*
//CLIENT EXEC ISPF,HLQ=ISP
PROFILE PREFIX(SPTHOLT)
ISPSTART CMD(%RXCVIRT)
//REQUESTS DD *
192.168.170.30:41102 /ws1.html+ws3?FromCurrency=EUR&amp;ToCurrency=GBP
/*
</pre></div>
</div>
<p>When running the REXX batch application the following URL is sent to
Virtel:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SEND-&gt; GET /WS1.HTML+WS3?FROMCURRENCY=EUR&amp;TOCURRENCY=GBP
    HTTP/1.1 Host: 192.168.170.30:41002
    Connection: keep-Accept:text/html,application/xhtml+xml,
    application/xml;q=0.9,image/webp,*/*;q=0.8

    Read from 192.168.170.30

Virtel IP Address: 192.168.170.30
LINE: HTTP-E
Port: 41102
Template: WS1.HTML
Transaction: WS3
Parameters: FROMCURRENCY=EUR,TOCURRENCY=GBP
</pre></div>
</div>
<ol class="arabic" start="2">
<li><p class="first">When Virtel receives the URL it invokes the transaction associated
with the Line related to the IP address and port. In this case it is
line E-HTTP which has an entry point of EDSPOINT. Within that entry
point, transaction WS3 is defined which has an initial scenario of
SCENRATE. It is this initial scenario that connects to the web
service, sends and receives the relevant SOAP messages and returns
the results to the batch application. This is an example of Virtel’s
web integration.</p>
<blockquote>
<div><p><a class="reference internal" href="../../../_images/image21.jpg"><img alt="image1" src="../../../_images/image21.jpg" style="width: 6.26806in; height: 3.52569in;" /></a>
<em>Figure 2 - User elements</em></p>
<p>The user elements involved in this stage of the transaction are the
batch application, REXX code RXCVIRT, the html template WS1.HTML
that Virtel will return, the presentation module code SCENRATE and
the SOAP message template exchange.xml . The template will contain
the response from the web service. Let’s take a look at these user
elements. The template looks like this:-</p>
</div></blockquote>
</li>
</ol>
<p><strong>WS1.HTML</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;!--
To change this license header, choose License Headers in Project
Properties.
To change this template file, choose Tools \| Templates
and open the template in the editor.
--&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;!--VIRTEL start=&quot;{{{&quot; end=&quot;}}}&quot; --&gt;
        &lt;title&gt;Web Services Example 1&lt;/title&gt;
        &lt;meta charset=&quot;UTF-8&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;/head&gt;
    &lt;body&gt;
        Answer is {{{CURRENT-VALUE-OF &quot;CANSWER&quot;}}}
    &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>The Virtel tag language is embedded in the html element to obtain
the contents of the variable CANSWER which will contain the results
from the web service. This is an example of the Virtel Web Access
toolkit. This user element is used at the end of the scenario when
Virtel sends the response to the initial URL that was initial posted
by the REXX batch application. If we trace the Virtel line E-HTTP
when we run the batch application we can see the data flow.</p>
<p><strong>Outbound Message from batch application</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>E-HTTP HTTP REQUEST FROM 192.168.170.030:02027
13:03:57.12

00000 47455420 2F575331 2E48544D 4C2B5753 333F4652 4F4D4355 5252454E 43593D45 *GET /WS1.HTML+WS3?FROMCURRENCY=E*
00020 55522654 4F435552 52454E43 593D4742 50202020 20202020 20202020 20202020 *UR&amp;TOCURRENCY=GBP *
00040 48545450 2F312E31 0D0A486F 73743A20 3139322E 3136382E 3137302E 33303A34 *HTTP/1.1..Host: 192.168.170.30:4*
00060 31303032 0D0A436F 6E6E6563 74696F6E 3A206B65 65702D61 6C697665 0D0A4163 *1002..Connection: keep-alive..Ac*
00080 63657074 3A207465 78742F68 746D6C2C 6170706C 69636174 696F6E2F 7868746D *cept: text/html,application/xhtm*
000A0 6C2B786D 6C2C6170 706C6963 6174696F 6E2F786D 6C3B713D 302E392C 696D6167 *l+xml,application/xml;q=0.9,imag*
000C0 652F7765 62702C2A 2F2A3B71 3D302E38 0D0A0D0A                            *e/webp,*/*;q=0.8.... *
</pre></div>
</div>
<p><strong>Inbound Message flow to batch application</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E</span><span class="o">-</span><span class="n">HTTP</span> <span class="n">HTTP</span> <span class="n">RESPONSE</span> <span class="n">TO</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">170.030</span><span class="p">:</span><span class="mi">02027</span>
<span class="mi">13</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">57.62</span>

<span class="mi">00000</span> <span class="mi">48545450</span> <span class="mi">2</span><span class="n">F312E31</span> <span class="mi">20323030</span> <span class="mi">204</span><span class="n">F6B0D</span> <span class="mi">0</span><span class="n">A536572</span> <span class="mi">7665723</span><span class="n">A</span> <span class="mi">20566972</span> <span class="mi">74656</span><span class="n">C2F</span> <span class="o">*</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">Ok</span><span class="o">..</span><span class="n">Server</span><span class="p">:</span> <span class="n">Virtel</span><span class="o">/*</span>
<span class="mi">00020</span> <span class="mf">342E3534</span> <span class="mi">0</span><span class="n">D0A4461</span> <span class="mi">74653</span><span class="n">A20</span> <span class="mf">53756E2</span><span class="n">C</span> <span class="mi">20323220</span> <span class="mi">4</span><span class="n">D617220</span> <span class="mi">32303135</span> <span class="mi">2031323</span><span class="n">A</span> <span class="o">*</span><span class="mf">4.54</span><span class="o">..</span><span class="n">Date</span><span class="p">:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">22</span> <span class="n">Mar</span> <span class="mi">2015</span> <span class="mi">12</span><span class="p">:</span><span class="o">*</span>
<span class="mi">00040</span> <span class="mi">30333</span><span class="n">A35</span> <span class="mi">3720474</span><span class="n">D</span> <span class="mi">54200</span><span class="n">D0A</span> <span class="mi">45787069</span> <span class="mi">7265733</span><span class="n">A</span> <span class="mi">20300</span><span class="n">D0A</span> <span class="mi">436</span><span class="n">F6E74</span> <span class="mf">656E742</span><span class="n">D</span> <span class="o">*</span><span class="mi">03</span><span class="p">:</span><span class="mi">57</span> <span class="n">GMT</span> <span class="o">..</span><span class="n">Expires</span><span class="p">:</span> <span class="mf">0.</span><span class="o">.</span><span class="n">Content</span><span class="o">-*</span>
<span class="mi">00060</span> <span class="mi">6</span><span class="n">C656E67</span> <span class="mi">74683</span><span class="n">A20</span> <span class="mi">30303030</span> <span class="mi">30303037</span> <span class="mi">0</span><span class="n">D0A436F</span> <span class="mf">6E74656</span><span class="n">E</span> <span class="mi">742</span><span class="n">D7479</span> <span class="mi">70653</span><span class="n">A20</span> <span class="o">*</span><span class="n">length</span><span class="p">:</span> <span class="mf">00000007.</span><span class="o">.</span><span class="n">Content</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="o">*</span>
<span class="mi">00080</span> <span class="mi">74657874</span> <span class="mi">2</span><span class="n">F68746D</span> <span class="mi">6</span><span class="n">C0D0A0D</span> <span class="mi">0</span><span class="n">A30302E</span> <span class="mi">37323336</span>                            <span class="o">*</span><span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="o">....</span><span class="mf">00.7236</span> <span class="o">*</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The inbound message is not using the template WS1.HTML in the above example, but rather just returning the CANSWER variable.</p>
</div>
<ol class="arabic" start="3">
<li><p class="first">The scenario associated with the transaction WS3 is a Virtel initial
scenario. It is defined with the following attributes:-</p>
<blockquote>
<div><p><a class="reference internal" href="../../../_images/image310.png"><img alt="image2" src="../../../_images/image310.png" style="width: 6.26806in; height: 4.04236in;" /></a>
<em>Figure 3 - WS3 Transaction definition</em></p>
<p>The key points are the <em>Application type 2</em>, a VIRTEL program, and
<em>TIOA at logon</em> set to &amp;/S which initiates the VIRTEL presentation
module SCENRATE that contains the INITIAL scenario. It is the
scenario within this presentation module that does all the work. See
Appendix A for a complete list of the presentation module SCENRATE.
This module must be assembled. The presentation module contains only
one scenario, an initial scenario which is invoked when an &amp;/S order
is found in a TIOA connection script (see “Connection /
Disconnection Scripts” in the <em>VIRTEL Connectivity Reference</em>
manual).</p>
<p>The layout of the scenario within the presentation module SCENRATE
can be defined as an output structure, defined between the OUTPUT
MAP$ and OUTPUT MAP$ END, followed by the SCENARIO logic. The logic
steps of the scenario can be broken down thus:-</p>
<ol class="loweralpha simple">
<li>Create variables from URL – FROMCURRENCY, TOCURRENCY</li>
<li>Set variable SITE to URL of web services provider and access port - <a class="reference external" href="http://www.webservices.net:80">www.webservices.net:80</a></li>
<li>Read in SOAP template from Virtel TRSF file – exchange.xml.</li>
<li>Build options file for $POST SOAP request – OPTION$ in Virtel variable REQP.</li>
<li>Send SOAP request to web services provider.</li>
<li>Test results and depending on return code take appropriate action. This is achieved using a Virtel CASE$ statement.</li>
<li>Copy Virtel ANSWER variable to a COMMAREA as mapped by the OUTPUT map area.</li>
<li>Copy the formatted COMMAREA to a Virtel variable called CANSWER.</li>
<li>Send template with CANSWER. This will cause the tagged area of the template WS1.HTML to be populated with the CANSWER variable or just send CANSWER variable.</li>
<li>Disconnect the session with the batch application.</li>
</ol>
</div></blockquote>
</li>
</ol>
<p>The user elements involved in the SOAP message request is template exchange.xml. The XML file looks like:-</p>
<p><strong>exchange.xml</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!--VIRTEL start=&quot;{{{&quot; end=&quot;}}}&quot;
--&gt;{{{ SET-CONTENT-TYPE &quot;text/xml&quot;}}}{{{SET-OUTPUT-ENCODING-UTF-8
&quot;&quot;}}}{{{SET-LOCAL-OPTIONS (XML-ESCAPES)}}}
&lt;soap12:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
xmlns:soap12=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;
    &lt;soap12:Body&gt;
        &lt;ConversionRate xmlns=&quot;http://www.webserviceX.NET/&quot;&gt;
            &lt;FromCurrency&gt;{{{TRIMMED-VALUE-OF &quot;FromCurrency&quot;}}}&lt;/FromCurrency&gt;
            &lt;ToCurrency&gt;{{{TRIMMED-VALUE-OF &quot;ToCurrency&quot;}}}&lt;/ToCurrency&gt;
        &lt;/ConversionRate&gt;
    &lt;/soap12:Body&gt;
&lt;/soap12:Envelope&gt;
</pre></div>
</div>
<p>The scenario takes the parameters from the URL and places them in Virtel
variables. This is an example of how Virtel’s integration works; through
a combination of scenario programmable elements and an Initial scenario.
The following is an extract from the scenario showing the relevant COPY$
statements:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>START       SET$ ENCODING,UTF-8,&#39;IBM1147&#39;
            COPY$ INPUT-TO-VARIABLE,FIELD=&#39;FROMCURRENCY&#39;,             *
                VAR=&#39;FROMCURRENCY&#39;,                                   *
                TYPE=REPLACE
*
            COPY$ INPUT-TO-VARIABLE,FIELD=&#39;TOCURRENCY&#39;,               *
                VAR=&#39;TOCURRENCY&#39;,                                     *
                TYPE=REPLACE
*
</pre></div>
</div>
<p>Again, Virtel tag language is used to populate the template with the
correct information for the web services request. The “TRIMMED-VALUE-OF”
of statements extract the values from the Virtel variables and place
them in the XML SOAP message template.</p>
<p>The OPTION$ and SEND$ complete the SOAP message, sending it to the web
service via the O-HHTP line, as identified in the SEND$ statement:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SENDREQ OPTION$ FOR-HTTP,(METHOD,&#39;POST&#39;),(SITE,&#39;*SITE&#39;),(TO,            *
                &#39;/CurrencyConvertor.asmx&#39;),                             *
                (HEADER,&#39;Content-Type: application/soap+xml&#39;),          *
                (FILE-OUT,&#39;REQFILE&#39;),(FILE-IN,                          *
                &#39;ANSWER&#39;),(RET-CODE,&#39;RETCODE&#39;),TOVAR=&#39;REQP&#39;
        SEND$ TO-LINE,LINE=&#39;O-HTTP&#39;,PARMS=&#39;REQP&#39;,MAXTIME=1000,          *
                ERROR=NOTOK
</pre></div>
</div>
<p>An analysis of the VIRTEL LOG can see the request being sent out to the
web services provider.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">13.02</span><span class="o">.</span><span class="mi">15</span> <span class="n">STC05752</span> <span class="n">VIR0200I</span> <span class="n">LINE</span><span class="o">=</span><span class="n">E</span><span class="o">-</span><span class="n">HTTP</span><span class="p">,</span><span class="n">TRACE</span>
<span class="mf">13.02</span><span class="o">.</span><span class="mi">15</span> <span class="n">STC05752</span> <span class="n">VIR0062I</span> <span class="n">HTTP</span><span class="o">-</span><span class="n">EDS</span> <span class="n">TRACE</span> <span class="n">ACTIVE</span>
<span class="mf">13.03</span><span class="o">.</span><span class="mi">57</span> <span class="n">STC05752</span> <span class="n">VIRT906I</span> <span class="n">HTTP</span><span class="o">-</span><span class="n">EDS</span> <span class="n">SOCKET</span> <span class="mi">00020000</span> <span class="n">CALL</span> <span class="n">FROM</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">170.030</span><span class="p">:</span><span class="mi">02027</span>
<span class="mf">13.03</span><span class="o">.</span><span class="mi">57</span> <span class="n">STC05752</span> <span class="n">VIRHT51I</span> <span class="n">HTTP</span><span class="o">-</span><span class="n">EDS</span> <span class="n">CONNECTING</span> <span class="n">EHLOC015</span> <span class="n">TO</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">170.030</span><span class="p">:</span><span class="mi">02027</span>
<span class="mf">13.03</span><span class="o">.</span><span class="mi">57</span> <span class="n">STC05752</span> <span class="n">VIRHT51I</span> <span class="n">HTTP</span><span class="o">-</span><span class="n">OUT</span> <span class="n">CONNECTING</span> <span class="n">EHLOC015</span> <span class="n">TO</span> <span class="mf">173.201</span><span class="o">.</span><span class="mf">044.188</span><span class="p">:</span><span class="mi">00080</span>
<span class="mf">13.03</span><span class="o">.</span><span class="mi">57</span> <span class="n">STC05752</span> <span class="n">VIRT922W</span> <span class="n">HTTP</span><span class="o">-</span><span class="n">OUT</span> <span class="n">SOCKET</span> <span class="mi">00000000</span> <span class="n">ENDED</span> <span class="n">FOR</span> <span class="mf">173.201</span><span class="o">.</span><span class="mf">044.188</span><span class="p">:</span><span class="mi">00080</span>
<span class="mf">13.03</span><span class="o">.</span><span class="mi">57</span> <span class="n">STC05752</span> <span class="n">VIR0052I</span> <span class="n">EHLOC015</span> <span class="n">DISCONNECTED</span> <span class="n">AFTER</span> <span class="mi">0</span> <span class="n">MINUTES</span>
<span class="mf">13.03</span><span class="o">.</span><span class="mi">57</span> <span class="n">STC05752</span> <span class="n">VIRT922W</span> <span class="n">HTTP</span><span class="o">-</span><span class="n">EDS</span> <span class="n">SOCKET</span> <span class="mi">00020000</span> <span class="n">ENDED</span> <span class="n">FOR</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">170.030</span><span class="p">:</span><span class="mi">020</span>
</pre></div>
</div>
<p>The CASE$ statement following the SEND$ tests the return code from the
web service and determines the appropriate action. Return codes
beginning with 2 or 5 are accepted as OK, whereas anything else is
considered not OK. The ANSWER variable is filled with the data returned
from the web service:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        CASE$ &#39;RETCODE&#39;,(BEGIN,&#39;2&#39;,OK),(BEGIN,&#39;5&#39;,OK),                  *
                ELSE=NOTOK
*
NOTOK COPY$ VALUE-TO-VARIABLE,VAR=&#39;ANSWER&#39;,VALUE=&#39;KO&#39;,TYPE=REPLACE
OK    EQU *
</pre></div>
</div>
<p>The ANSWER variable contains the result from the web service. This is
converted to EBCDIC and then copied to the COMMAREA variable. The
COMMAREA variable is then copied to a Virtel CANSWER variable and passed
back to the batch application through the template WS1.HTML:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        CONVERT$ ASCII-TO-EBCDIC,VAR=&#39;ANSWER&#39;
OUTPUT  MAP$ FROM-VARIABLE,VAR=&#39;ANSWER&#39;           Answer -&gt; Commarea
OUTPUT  MAP$ TO-VARIABLE,VAR=&#39;CANSWER&#39;            Commarea -&gt; Variable
        CONVERT$ EBCDIC-TO-ASCII,VAR=&#39;CANSWER&#39;
        SEND$ AS-ANSWER,VAR=&#39;CANSWER&#39;,TYPE=&#39;text/html&#39;
        ACTION$ DISCONNECT
</pre></div>
</div>
<p>The COMMAREA variable is a special variable that Virtel can use to
interface with application programs that communicate through a COMMAREA
structure, such as CICS or IMS. The Virtel modernisation and integration
tool kits provide significate program capability to utilize a COMMAREA
intermediate buffer in processing requests and returning responses
between Virtel and COMMAREA related programs.</p>
<p>See “Virtel Modernisation and Virtel Integration chapters “ in the
<em>VIRTEL Web Access Guide</em> manual) for more information.</p>
<p>In the Virtel line trace for the line O-HTTP the SOAP messages can be
traced:-</p>
<p><strong>Outbound SOAP message to web services server</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>*POST /CurrencyConvertor.asmx HTT*
*P/1.1..Host: www.webservicex.net*
*:80..Content-Type: application/s*
*oap+xml..Content-length: 0000042*
*3....&lt;?xml version=&quot;1.0&quot; encodin*
*g=&quot;UTF-8&quot;?&gt;..&lt;soap12:Envelope xm*
*lns:xsi=&quot;http://www.w3.org/2001/*
*XMLSchema-instance&quot; xmlns:xsd=&quot;h*
*ttp://www.w3.org/2001/XMLSchema&quot;*
* xmlns:soap12=&quot;http://www.w3.org*
*/2003/05/soap-envelope&quot;&gt;.. &lt;soa*
*p12:Body&gt;.. &lt;ConversionRate x*
*mlns=&quot;http://www.webserviceX.NET*
*/&quot;&gt;.. &lt;FromCurrency&gt;EUR&lt;/Fr*
*omCurrency&gt;.. &lt;ToCurrency&gt;G*
*BP&lt;/ToCurrency&gt;.. &lt;/Conversio*
*nRate&gt;.. &lt;/soap12:Body&gt;..&lt;/soap*
*12:Envelope&gt; *
</pre></div>
</div>
<p><strong>Inbound SOAP message from web services server</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>*HTTP/1.1 200 OK..Cache-Control: *
*private, max-age=0..Content-Leng*
*th: 380..Content-Type: applicati*
*on/soap+xml; charset=utf-8..Serv*
*er: Microsoft-IIS/7.0..X-AspNet-*
*Version: 4.0.30319..X-Powered-By*
*: ASP.NET..Date: Sat, 21 Mar 201*
*5 15:58:29 GMT....&lt;?xml version=*
*&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:En*
*velope xmlns:soap=&quot;http://www.w3*
*.org/2003/05/soap-envelope&quot; xmln*
*s:xsi=&quot;http://www.w3.org/2001/XM*
*LSchema-instance&quot; xmlns:xsd=&quot;htt*
*p://www.w3.org/2001/XMLSchema&quot;&gt;&lt;*bastet
*soap:Body&gt;&lt;ConversionRateRespons*
*e xmlns=&quot;http://www.webserviceX.*
*NET/&quot;&gt;&lt;ConversionRateResult&gt;0.72*
*36&lt;/ConversionRateResult&gt;&lt;/Conve*
*rsionRateResponse&gt;&lt;/soap:Body&gt;&lt;/*
*soap:Envelope&gt; *
</pre></div>
</div>
<ol class="arabic" start="4">
<li><p class="first">The web services provided by
<a class="reference external" href="http://www.webserviceX.net">www.webserviceX.net</a> can be
discovered and exploited by analysis of the associated WSDLs. The
home page of the site lists the most popular web services that the
provider supports:-</p>
<blockquote>
<div><p><a class="reference internal" href="../../../_images/image48.png"><img alt="image3" src="../../../_images/image48.png" style="width: 6.26806in; height: 3.17778in;" /></a></p>
</div></blockquote>
</li>
</ol>
<p>The Web Service that the batch application invokes is Currency
Calculator. This web service provides realtime exchange rate data
for a large number of global currencies. If we view the WSDL of the
Currency convertor we can see the operations provided by this
particular service. The WSDL can be seen by using the following
URL:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://www.webservicex.net/CurrencyConvertor.asmx?WSDL
</pre></div>
</div>
<p>In the service element of the WSDL we can see that the web service
supports different protocols to the same service, that being
CurrencyConvertor. The web service supports SOAP 1.0, SOAP 1.2, HTTP
GET and HTTP POST. In this example the SOAP 1.2 POST implementation
of CurrencyConvertor is being used:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">wsdl</span><span class="p">:</span><span class="n">service</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CurrencyConvertor&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CurrencyConvertorSoap&quot;</span> <span class="n">binding</span><span class="o">=</span><span class="s2">&quot;tns:CurrencyConvertorSoap&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">soap</span><span class="p">:</span><span class="n">address</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;http://www.webservicex.net/CurrencyConvertor.asmx&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CurrencyConvertorSoap12&quot;</span> <span class="n">binding</span><span class="o">=</span><span class="s2">&quot;tns:CurrencyConvertorSoap12&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">soap12</span><span class="p">:</span><span class="n">address</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;http://www.webservicex.net/CurrencyConvertor.asmx&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CurrencyConvertorHttpGet&quot;</span> <span class="n">binding</span><span class="o">=</span><span class="s2">&quot;tns:CurrencyConvertorHttpGet&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">http</span><span class="p">:</span><span class="n">address</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;http://www.webservicex.net/CurrencyConvertor.asmx&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CurrencyConvertorHttpPost&quot;</span> <span class="n">binding</span><span class="o">=</span><span class="s2">&quot;tns:CurrencyConvertorHttpPost&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">http</span><span class="p">:</span><span class="n">address</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;http://www.webservicex.net/CurrencyConvertor.asmx&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">wsdl</span><span class="p">:</span><span class="n">port</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">wsdl</span><span class="p">:</span><span class="n">service</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>It is not the intention of the newsletter to delve into the WSDL
structure, there are many excellent books, journals and internet
pages devoted to this subject. The following URL,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://www.webservicex.net/CurrencyConvertor.asmx?op=ConversionRate
</pre></div>
</div>
<p>provides details on the structure on the SOAP request and response
messages. This is useful for building the exchange.xml template and
for analysing the response message within the scenario.</p>
<p><strong>SOAP 1.2 Example</strong></p>
<p>The following is a sample SOAP 1.2 request and response. The placeholders&nbsp;shown need to be replaced with actual values.</p>
<p><em>REQUEST message</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>POST /CurrencyConvertor.asmx HTTP/1.1
Host: www.webservicex.net
Content-Type: application/soap+xml; charset=utf-8
Content-Length: length

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;soap12:Envelope
xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
xmlns:soap12=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;
    &lt;soap12:Body&gt;
        &lt;ConversionRate xmlns=&quot;http://www.webserviceX.NET/&quot;&gt;
            &lt;FromCurrency&gt;**AFA**\ &lt;/FromCurrency&gt;
            &lt;ToCurrency&gt;**DZD**\ &lt;/ToCurrency&gt;
        &lt;/ConversionRate&gt;
    &lt;/soap12:Body&gt;
&lt;/soap12:Envelope&gt;
</pre></div>
</div>
<p><em>RESPONSE message</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;soap12:Envelope
xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
xmlns:soap12=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;
    &lt;soap12:Body&gt;
        &lt;ConversionRateResponse xmlns=&quot;http://www.webserviceX.NET/&quot;&gt;
            &lt;ConversionRateResult&gt;double&lt;/ConversionRateResult&gt;
        &lt;/ConversionRateResponse&gt;
    &lt;/soap12:Body&gt;
&lt;/soap12:Envelope&gt;
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li>After receiving the SOAP response the scenario will search for the
element ConversionRateResult and extract the value and placing in to
the Virtel ANSWER variable. If there is an error, the
ConversionRateResult value will contain details of the web services
error. The scenario will copy this error message to the ANSWER
variable. In both cases the results are contained within the
ConversionRateResult element. These operations are executed through
the MAP$ EVENTUAL-AREA statement:-</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>MAP$ EVENTUAL-AREA,FROM-CONSTANT,&#39;0&#39;,WHEN=(ELEMENT,              *
    &#39;ConversionRateResult&#39;),EVENT=&#39;Response&#39;,LENGTH=6
</pre></div>
</div>
<p>The RESPONSE format area is designated by the O00000001 MAP$ BEGIN,
EVENT=RESPONSE and terminated by the O00000001 MAP$ END. The value
is mapped by the MAP$ AREA,WITH ‘ConversionRateResult’ statement:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>O0000001    MAP$ BEGIN,EVENT=&#39;Response&#39;
            MAP$ AREA,WITH=&#39;ConversionRateResult&#39;,TYPE=9,LENGTH=6
O0000001    MAP$ END
</pre></div>
</div>
<p>If the response message from the web service does not contain the
element ConversionRateResult then the OFAULT area is mapped out
within an XML structure in preparation to return to the batch
application. The ‘fault’ elements will be extracted from the SOAP
response:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>OFAULT      MAP$ BEGIN,EVENT=&#39;Fault&#39;
            MAP$ AREA,WITH=&#39;faultcode&#39;,TYPE=X,LENGTH=32
            MAP$ AREA,WITH=&#39;faultstring&#39;,TYPE=X,LENGTH=32
            MAP$ AREA,WITH=&#39;faultactor&#39;,TYPE=X,LENGTH=32
            MAP$ AREA,FROM-CONSTANT,&#39; &#39;,LENGTH=32
OFAULT      MAP$ END
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li>When the batch application receives the response to the original URI
request the answer will be contained within the WS1.HTML template,
where the CANSWER area has been captured. The first character of the
CANSWER area, as posted by the scenario, will either be a 0 or a 1. A
zero indicates success, a one indicates an error:-</li>
</ol>
<p><strong>Result:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!DOCTYPE html&gt;

&lt;!-- To change this license header, choose License Headers in
Project Properties. To change this template file, choose Tools \|
Templates and open the template in the editor. --&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Web Services Example 1&lt;/title&gt;
        &lt;meta charset=&quot;UTF-8&quot;&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;/head&gt;
    &lt;body&gt;
        Answer is 00.7312             *[The first zero is a return code]*
    &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Instead of returning the template, the scenario can just return the
CANSWER variable within a HTTP response. This is achieved by adding
the following three lines to the scenario:-</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>label       CONVERT$ EBCDIC-TO-ASCII,VAR=&#39;CANSWER&#39;
            SEND$ AS-ANSWER,VAR=&#39;CANSWER&#39;,TYPE=&#39;text/html&#39;
            ACTION$ DISCONNECT
</pre></div>
</div>
<p>Instead of returning the template, the HTTP response will now just
contain the variable CANSWER, which is all that is required by the
batch application.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ISPSTART</span> <span class="n">CMD</span><span class="p">(</span><span class="o">%</span><span class="n">RXCVIRT</span><span class="p">)</span>
    <span class="n">Result</span><span class="p">:</span> <span class="mf">0.7312</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All the source related to this newsletter can be downloaded from the
Virtel FTP web site. The file name is zostn2501506.zip.</p>
</div>
<p><strong>Appendix A SCENRATE Scenario</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SCENRATE    SCREENS APPL=SCENRATE,EXEC=NO
            SCENARIO INITIAL
*
* Output structure definition
*
OUTPUT      MAP$ BEGIN
            MAP$ EVENTUAL-AREA,FROM-CONSTANT,&#39;0&#39;,WHEN=(ELEMENT,           *
                &#39;ConversionRateResult&#39;),EVENT=&#39;Response&#39;,LENGTH=6
            MAP$ ELSETHEN-AREA,FROM-CONSTANT,&#39;1&#39;,EVENT=&#39;Fault&#39;,LENGTH=1
OENV        MAP$ BEGIN,TOP,WITH=&#39;soap:Envelope&#39;
*HEADER     MAP$ BEGIN,WITH=&#39;soap:Header&#39;
*HEADER     MAP$ END
OBODY       MAP$ BEGIN,WITH=&#39;soap:Body&#39;
*
OFAULT      MAP$ BEGIN,EVENT=&#39;Fault&#39;
            MAP$ AREA,WITH=&#39;faultcode&#39;,TYPE=X,LENGTH=32
            MAP$ AREA,WITH=&#39;faultstring&#39;,TYPE=X,LENGTH=32
            MAP$ AREA,WITH=&#39;faultactor&#39;,TYPE=X,LENGTH=32
            MAP$ AREA,FROM-CONSTANT,&#39; &#39;,LENGTH=32
OFAULT      MAP$ END
*
O0000001    MAP$ BEGIN,EVENT=&#39;Response&#39;
            MAP$ AREA,WITH=&#39;ConversionRateResult&#39;,TYPE=9,LENGTH=6
O0000001    MAP$ END
*
OBODY       MAP$ END
OENV        MAP$ END
OUTPUT      MAP$ END
*
START       SET$ ENCODING,UTF-8,&#39;IBM1147&#39;
            COPY$ INPUT-TO-VARIABLE,FIELD=&#39;FROMCURRENCY&#39;,                 *
                VAR=&#39;FROMCURRENCY&#39;,                                       *
                TYPE=REPLACE
*
            COPY$ INPUT-TO-VARIABLE,FIELD=&#39;TOCURRENCY&#39;,                   *
                VAR=&#39;TOCURRENCY&#39;,                                         *
                TYPE=REPLACE
*
            COPY$ VALUE-TO-VARIABLE,VAR=&#39;SITE&#39;,                           *
                VALUE=&#39;www.webservicex.net:80&#39;,                           *
                TYPE=REPLACE
*
            COPY$ OUTPUT-FILE-TO-VARIABLE,FILE=&#39;exchange.xml&#39;,            *
                VAR=&#39;REQFILE&#39;
*
            SENDREQ OPTION$ FOR-HTTP,(METHOD,&#39;POST&#39;),(SITE,&#39;*SITE&#39;),(TO,  *
                &#39;/CurrencyConvertor.asmx&#39;),                               *
                (HEADER,&#39;Content-Type: application/soap+xml&#39;),            *
                (FILE-OUT,&#39;REQFILE&#39;),(FILE-IN,                            *
                &#39;ANSWER&#39;),(RET-CODE,&#39;RETCODE&#39;),TOVAR=&#39;REQP&#39;
            SEND$ TO-LINE,LINE=&#39;O-HTTP&#39;,PARMS=&#39;REQP&#39;,MAXTIME=1000,        *
                ERROR=NOTOK
            CASE$ &#39;RETCODE&#39;,(BEGIN,&#39;2&#39;,OK),(BEGIN,&#39;5&#39;,OK),                *
                ELSE=NOTOK
*
NOTOK       COPY$ VALUE-TO-VARIABLE,VAR=&#39;ANSWER&#39;,VALUE=&#39;KO&#39;,TYPE=REPLACE
OK          EQU *
            CONVERT$ ASCII-TO-EBCDIC,VAR=&#39;ANSWER&#39;
OUTPUT      MAP$ FROM-VARIABLE,VAR=&#39;ANSWER&#39; Answer -&gt; Commarea
OUTPUT      MAP$ TO-VARIABLE,VAR=&#39;CANSWER&#39; Commarea -&gt; Variable
            CONVERT$ EBCDIC-TO-ASCII,VAR=&#39;CANSWER&#39;
            SEND$ AS-ANSWER,VAR=&#39;CANSWER&#39;,TYPE=&#39;text/html&#39;
            ACTION$ DISCONNECT
*
            SCENARIO END
            SCRNEND
            END
</pre></div>
</div>
<p><strong>Appendix B RXCVIRT REXX CLIST</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*Rexx------------------------------------------------------------------

 Syspertec
 www.syspertec.com
 Extract Batch call to Virtel to invoke web services
 Author: Ed Holt

 Maintenance
 Date         By             Description
 01/03/2015   ESH            Created

 Notes:

 ----------------------------------------------------------------------*/
trace 0
debug = 0
/*********************************************************************/
/* Open connection with Virtel                                       */
/*********************************************************************/
call read_requests            /* Read in control cards         */

do i = 1 to requests.0
   n = 1
   clisock = &#39;&#39;
   parse upper var requests.i string&#39;:&#39;port url
   parse upper var string ipaddr
   ipaddress.0 = 1
   ipaddress.1 = ipaddr
   call  init_sock
   response = &#39;&#39;
   request = build_request()     /* Build request block           */
   call process                  /* Process request               */
   /***************************************************************/
   /* Look for URL= in response. If found the request page from   */
   /* virtel. HTTP 302                                            */
   /***************************************************************/
   keyword=&quot;URL=&quot;
   url = substr(search_line(keyword,response),length(keyword)+1)
   if (url &lt;&gt; &#39;&#39;) then do
     request = build_request()   /* Build request block           */
     call process                /* Process request               */
   end
   call clean_up                 /* Clean up socket               */
end
exit 0

/***************************************************************/
/* read_requests                                               */
/*                                                             */
/* Read in control cards                                       */
/***************************************************************/
read_requests:
&quot;EXECIO * DISKR  REQUESTS ( FINIS STEM requests.&quot;
return

/***************************************************************/
/* build_request                                               */
/*                                                             */
/* build request area                                          */
/***************************************************************/
build_request:
http =       &quot;HTTP/1.1&quot;
host =       &quot;Host: 192.168.170.30:41002&quot;
connection = &quot;Connection: keep-alive&quot;
accept     = &quot;Accept: text/html,application/xhtml+xml&quot;
accept     = accept || &quot;,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;
useragent = &quot;User-Agent: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36&quot;
useragent = useragent || &quot; (KHTML, like Gecko)&quot;
useragent = useragent || &quot; Chrome/40.0.2214.115 Safari/537.36&quot;
acceptencoding = &quot;Accept-Encoding: gzip, deflate, sdch&quot;
acceptlanguage = &quot;Accept-Language: en-US,en;q=0.8&quot;
cookie     = &quot;Cookie: SYSLANG=en; SYSSTYL=BLUE; SYSPAGE=auto&quot;
eol        = &quot;0d0a&quot;x
request = &quot;GET&quot; url http || eol || host || eol
request = request || connection || eol
request = request || accept || eol
requesv = request || useragent || eol
requesw = request || acceptencoding || eol
requesx = request || acceptlanguage || eol
requesz = request || cookie || eol
request = request || eol
return request

/***************************************************************/
/* Process                                                     */
/*                                                             */
/* Send request to server and get response.                    */
/* Test for &quot;Error&quot; or &quot;Shutdown&quot;. Also, if srchflag, check to */
/* see if data has been located in response buffer.            */
/***************************************************************/
process:
do n=1 by 1 until n = ipaddress.0
   data = get_data(ipaddress.n, request)

   if word(data,1) ¬= &#39;Error&#39; &amp; request ¬= &#39;SHUTDOWN&#39; then do
      if srch ¬= &#39;&#39; &amp; srchflag = 0 then
         say &quot;Search keyword &quot; || srch || &quot; not found.&quot;
   end
   if word(data,1) = &#39;Error&#39; then
      say &quot;Server &quot; || ipaddress.n &quot; has experienced an error.&quot;
end
return

/***************************************************************/
/* init_sock                                                   */
/*                                                             */
/* Initialise socket                                           */
/***************************************************************/
init_sock:
x=&#39;SOCKET&#39;(&#39;SocketSetStatus&#39;)            /* Socket already?    */
if word(x,1)=&#39;0&#39; then
   x=&#39;SOCKET&#39;(&#39;terminate&#39;)

x=&#39;SOCKET&#39;(&#39;initialize&#39;,&#39;rsclient&#39;)      /* Initialize Socket  */
if word(x,1)¬=&#39;0&#39; then do
   say &#39;Error initialising rsclient&#39;
   exit
end

if ipaddress.n=&#39;none&#39; then do            /* Get our IP address */
  x=&#39;SOCKET&#39;(&#39;gethostid&#39;)
  if word(x,1)¬=&#39;0&#39; then do
     say &#39;Error trying to get host id&#39;
     call clean_up
     exit
  end
  else ipaddress.n=word(x,2)
end

x = &#39;SOCKET&#39;(&#39;SOCKET&#39;)                   /* Open socket        */
if word(x,1)¬=&#39;0&#39; then do
   say &#39;Error issuing socket&#39;
   call clean_up
   exit
end

clisock=WORD(x,2)                        /* Get Socket ID      */
x=&#39;SOCKET&#39;(&#39;gethostname&#39;)                /* Get host name      */
if word(x,1)¬=&#39;0&#39; then do
   say &#39;Error getting host name&#39;
   call clean_up
   exit
end

hostname = word(x,2)
x=&#39;SOCKET&#39;(&#39;connect&#39;,clisock,&#39;af_inet&#39; port ipaddress.n)
if word(x,1) = &#39;61&#39; then do             /* Socket refused      */
   call clean_up
   return &quot;Error - No connection with &quot; || ipaddress.n
end
if debug == 1 then
   say &quot;Connected &quot; || ipaddress.n      /* Connect Success     */

if word(x,1)¬=&#39;0&#39; then do
   call clean_up
   return &quot;Error - issuing af_net with &quot; || ipaddress.n
end
return

/***************************************************************/
/* get_data                                                    */
/*                                                             */
/* Set up socket, send request buffer and get response buffer. */
/* Test for &quot;Error&quot; or &quot;Shutdown&quot;. Also, if srchflag, check to */
/* see if data has been located in response buffer.            */
/***************************************************************/
get_data:
if debug == 1 then
   say &quot;SEND-&gt;&quot; request
senddata = EBCDIC_to_ASCII(request)     /* Send Data           */
x=&#39;SOCKET&#39;(&#39;send&#39;,clisock,senddata)     /* on socket           */
if word(x,1)¬=&#39;0&#39; then do
   call clean_up
   return &quot;Error - issuing send &quot; || ipaddress.n
end
response = &#39;&#39;                           /* Initialize response */

do
   x=&#39;SOCKET&#39;(&#39;read&#39;,clisock)           /* Get data            */
   if word(x,1)¬=&#39;0&#39; then do
      parse var x . error
      call clean_up
      return &quot;Error - issuing recv &quot; || ipaddress.n
   end
   if debug == 1 then
      say &quot;Read from &quot; || ipaddress.n
   if word(x,2)==&#39;0&#39; then leave         /* Null line? Abort    */
   parse var x . . dataline             /* Get data and convert*/

   dataline = ASCII_TO_EBCDIC(dataline) /* from a2e          */
   if debug == 1 then
      say &quot;RECV &lt;-&quot; dataline

   response = dataline                  /* Build response buff.*/
   do until index(dataline,&#39;0d&#39;x)=0     /* Remove any lf       */
      parse var dataline nextline &#39;0d&#39;x dataline
      response = response || nextline   /* Build response buff.*/
   end
   parse var response  . &#39;text/html&#39; answer &#39;HTTP&#39; .
   x      = translate(answer,&#39; &#39;,&#39;25&#39;x) /* Remove any LF       */
   answer = translate(x,&#39; &#39;,&#39;0d&#39;x)      /* Remove any CR       */
   answer = strip(answer)
   rc = substr(answer,1,1)
   result = substr(answer,2)
   if (rc != 0) then
      Say &#39;Error: &#39;result
   else
      say &#39;Result: &#39;result
end
return 0

/***************************************************************/
/* search_lines                                                */
/*                                                             */
/* Search for argument within response buffer.                 */
/***************************************************************/
search_line:
parse arg needle,haystack
if index(haystack,needle) &gt; 0 then do
 str = substr(haystack,index(haystack,needle))
 return substr(str,1,index(str,&#39;&quot;&#39;)-1)
end
return &#39;&#39;

/***************************************************************/
/* Clean_up                                                    */
/*                                                             */
/***************************************************************/
clean_up:
x=&#39;SOCKET&#39;(&#39;Terminate&#39;,&#39;RSCLIENT&#39;)
if debug == 1 then
   say &quot;Terminate &quot; || ipaddress.n
return 0

/***************************************************************/
/*       EBCDIC To ASCII &amp; ASCII To EBCDIC Translate Tables    */
/***************************************************************/
ASCII_to_EBCDIC: Procedure
parse arg ASCII_data

a2etab = &#39;00010203 372D2E2F 1605250B 0C0D0E0F&#39;x || ,
         &#39;10111213 3C3D3226 18193F27 1C1D1E1F&#39;x || ,
         &#39;405A7F7B 5B6C507D 4D5D5C4E 6B604B61&#39;x || ,
         &#39;F0F1F2F3 F4F5F6F7 F8F97A5E 4C7E6E6F&#39;x || ,
         &#39;7CC1C2C3 C4C5C6C7 C8C9D1D2 D3D4D5D6&#39;x || ,
         &#39;D7D8D9E2 E3E4E5E6 E7E8E9AD E0BD5F6D&#39;x || ,
         &#39;79818283 84858687 88899192 93949596&#39;x || ,
         &#39;979899A2 A3A4A5A6 A7A8A9C0 4FD0A107&#39;x || ,
         &#39;20212223 24150617 28292A2B 2C090A1B&#39;x || ,
         &#39;30311A33 34353608 38393A3B 04143EFF&#39;x || ,
         &#39;41AA4AB1 9FB26AB5 BBB49A8A B0CAAFBC&#39;x || ,
         &#39;908FEAFA BEA0B6B3 9DDA9B8B B7B8B9AB&#39;x || ,
         &#39;64656266 63679E68 74717273 78757677&#39;x || ,
         &#39;AC69EDEE EBEFECBF 80FDFEFB FCBAAE59&#39;x || ,
         &#39;44454246 43479C48 54515253 58555657&#39;x || ,
         &#39;8C49CDCE CBCFCCE1 70DDDEDB DC8D8EDF&#39;x

EBCDIC_data = translate(ASCII_data,a2etab)
return EBCDIC_data

EBCDIC_to_ASCII: Procedure
parse arg EBCDIC_data

e2atab = &#39;00010203 04050607 08090A0B 0C0D0E0F&#39;x || ,
         &#39;10111213 14151617 18191A1B 1C1D1E1F&#39;x || ,
         &#39;20212223 24252627 28292A2B 2C2D2E2F&#39;x || ,
         &#39;30313233 34353637 38393A3B 3C3D3E3F&#39;x || ,
         &#39;20414243 44454647 48499C2E 3C282B7C&#39;x || ,
         &#39;26515253 54555657 58592124 2A293B5F&#39;x || ,
         &#39;2D2F6263 64656667 68697C2C 255F3E3F&#39;x || ,
         &#39;70717273 74757677 78603A23 40273D22&#39;x || ,
         &#39;80616263 64656667 68698A8B 8C8D8E8F&#39;x || ,
         &#39;906A6B6C 6D6E6F70 71729A9B 9C9D9E9F&#39;x || ,
         &#39;A07E7374 75767778 797AAAAB AC5BAEAF&#39;x || ,
         &#39;B0B1B2B3 B4B5B6B7 B8B9BABB BC5DBEBF&#39;x || ,
         &#39;7B414243 44454647 4849CACB CCCDCECF&#39;x || ,
         &#39;7D4A4B4C 4D4E4F50 5152DADB DCDDDEDF&#39;x || ,
         &#39;5CE15354 55565758 595AEAEB ECEDEEEF&#39;x || ,
         &#39;30313233 34353637 3839FAFB FCFDFEFF&#39;x
 ASCII_data = translate(EBCDIC_data, e2atab)
 return ASCII_data
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../TN201507/TN201507.html" class="btn btn-neutral float-right" title="Customising Virtel" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../TN201505/TN201505.html" class="btn btn-neutral float-left" title="Virtel Macros in Virtel 4.53" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017, Syspertec. All rights reserved

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>