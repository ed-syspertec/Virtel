

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Protecting Virtel Applications with Shibboleth &mdash; Virtel 1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Virtel 1 documentation" href="../../../index.html"/>
        <link rel="up" title="Technical Newsletters" href="../../../newsletters.html"/>
        <link rel="next" title="Passticket support with CA Top Secret" href="../TN201703/TN201703.html"/>
        <link rel="prev" title="Protecting business assets" href="../TN201701/TN201701.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Virtel
          

          
            
            <img src="../../../_static/logo_virtel_web.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../newsletters.html">Technical Newsletters</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id1">2014</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id2">2015</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../newsletters.html#id3">2016</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../newsletters.html#id4">2017</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../TN201701/TN201701.html">Protecting business assets</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Protecting Virtel Applications with Shibboleth</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201703/TN201703.html">Passticket support with CA Top Secret</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TN201704/TN201704.html">Virtel Macros</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto.html">Miscellaneous</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Virtel</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../newsletters.html">Technical Newsletters</a> &raquo;</li>
      
    <li>Protecting Virtel Applications with Shibboleth</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/manuals/newsletters/TN201702/TN201702.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="protecting-virtel-applications-with-shibboleth">
<h1>Protecting Virtel Applications with Shibboleth<a class="headerlink" href="#protecting-virtel-applications-with-shibboleth" title="Permalink to this headline">¶</a></h1>
<p>This newsletter provides a summary of the configuration tasks involved
in setting up a Shibboleth / Virtel SAML environment. It does not go
through the Shibboleth IDP or SP installation in detail. The reader
should research further for that information. It does, however,
highlight the relevant files that had to be configured to get the
interfaces to work within the context of an SSO solution.</p>
<p>Shibboleth is an “authentication” service, sometimes referred to as a
federated identity management tool. It consists of two parts – a service
provider (SP) and an identify provider (IDP). It also uses an LDAP
server and Apache web servers to provide additional services. The
communication protocol between the IDP, SP and other components is
through SAML, a XML based language. The SP protects its supporting
applications by authorising a user first before allowing access. It can
protect its applications with a SSO facility. It builds a security
context by communicating with the IDP to obtain attributes like userid
(uid), common name (cun), surname (sun) and email address (mail).</p>
<p>Normally there is one local “home” identity provider which can be shared
by many service providers. The security attributes are maintained in a
LDAP server, with the IDP making requests to extract information on
behave of the SP when validating users. The extracted information is
return to the SP once the user has been validated. Validation can be
through certificates or a simple userid and password.</p>
<p>The Virtel applications, as listed under the APPMENU, are accessed
through the protected URL <a class="reference external" href="https://sp.syspertec.com/Virtel">https://sp.syspertec.com/Virtel</a>. Once a user
has been validated by Shibboleth the the Virtel APPMENU will appear
listing the applications supported by Virtel. A user will select their
application and will be logged on with further need to provide any
userid or password. Virtel and Shibboleth use a SSO method for accessing
Virtel applications. The UID from the LDAP is used in a HTTP SM_Header
which is passed to Virtel. Using a Scenario, Virtel obtains a PASSTICKET
and logs onto the application using the USERID and generated pass
ticket. See the technical newsletter <em>2014/07 – Pass tickets and
supporting Proxy Servers</em> for further details on how to configure Virtel
to use HTTP headers in support of an SSO environment.</p>
<p>Once a user has been validated the security context built by Shibboleth
will remain within the browser cache so access to any protected resource
will be permitted using the same security attributes. This means that
any secure application listed in the Virtel APPMEN can be access without
further signon validation. Each time a new application is selected a new
passticket will be generated. This assume that all applications within
the APPMENU list have been set up to support PASSTICKETS.</p>
<p>Security between the SP and Virtel is over TLS/SSL. To implement this
secure HTTPS session requires that Virtel is setup to interface with
AT-TLS. See the Virtel document <em>“How to activate VIRTEL https using
AT-TLS”</em> for further information on setting up the z/OS PAGENT
configuration. The newsletter <em>2014/16 – Virtel TLS/SSL Security:
Signing on using server and client certificates</em> is also a good
reference.</p>
<p>Note: that our Shibboleth testing we did not use client certificates in
establishing a session with Virtel.</p>
<p><strong>Flow overview</strong></p>
<p><a class="reference internal" href="../../../_images/image19.jpg"><img alt="image0" src="../../../_images/image19.jpg" style="width: 6.26806in; height: 3.68681in;" /></a></p>
<p>Figure Overview of logon sequence</p>
<ol class="arabic">
<li><p class="first">User accesses Virtel entity through URL
<a class="reference external" href="https://sp.syspertec.com/Virtel">https://sp.syspertec.com/Virtel</a></p>
</li>
<li><p class="first">Service provider requests userid and password through logon
template:-</p>
<blockquote>
<div><p><a class="reference internal" href="../../../_images/image226.png"><img alt="image1" src="../../../_images/image226.png" style="width: 4.79057in; height: 3.17708in;" /></a></p>
</div></blockquote>
</li>
</ol>
<ol class="arabic">
<li><p class="first">IDP validates user credentials against LDAP attributes.</p>
</li>
<li><p class="first">IDP returns selected attributes to SP. In this case only the UID is
required.</p>
</li>
<li><p class="first">SP redirects user to Virtel APPMENU passing the UID as a header in
the HTTP request – SM_USER.</p>
</li>
<li><p class="first">Virtel presents application menu.</p>
<blockquote>
<div><p><a class="reference internal" href="../../../_images/image323.png"><img alt="image2" src="../../../_images/image323.png" style="width: 5.26604in; height: 4.00000in;" /></a></p>
</div></blockquote>
</li>
</ol>
<ol class="arabic">
<li><p class="first">User selects applications and logs on without specifying userid or
password. Virtel uses the SM_USER header to generate a PASSTICKET
for the userid.</p>
<blockquote>
<div><p><a class="reference internal" href="../../../_images/image419.png"><img alt="image3" src="../../../_images/image419.png" style="width: 5.30208in; height: 4.04323in;" /></a></p>
</div></blockquote>
</li>
</ol>
<p><strong>Setting up the IDP environment</strong></p>
<p>IDP Version 3</p>
<p>The Shibboleth IDP is a Java web application that runs within a Servet
container - In our case we use Tomcat. Tomcat runs on the Milan server.
The IP address of Milan is 192.168.92.190</p>
<p>Using V3 is problematic as most of the “user install” documentation
refers to V2. There are a lot of differences!</p>
<p>IDP <a class="reference external" href="https://idp.syspertec.com/idp">https://idp.syspertec.com/idp</a></p>
<p>IDP_HOME /opt/shibboleth-idp</p>
<p>IDP Configuration files $IDP_HOME/conf</p>
<p>TOMCAT <a class="reference external" href="http://idp.syspertec.com:8081">http://idp.syspertec.com:8081</a> Tomcat Web Page</p>
<p>Web Manager Application admin/password</p>
<p>$TOMCAT-HOME /usr/share/tomcat</p>
<p>Tomcat Configuration files $TOMCAT_HOME/conf</p>
<p>The IDP is enabled for SSL and has a keystore containing the necessary
security credentials. The idea behind this is that traffic is secure on
the login and any communication between the SP and IDP. The keystore is
called idpself.keystore - the pass phrase is “VirtelIsGreat”.</p>
<p>The keystore was generated with the “keytool” program:-</p>
<p># cd $TOMCAT-HOME</p>
<p># mkdir credentials</p>
<p># cd credentials</p>
<p># keytool –genkey –alias tomcat –keyalg RSA –keystore idpself.keystore</p>
<p>This keystore is defined in the Tomcat server.xml file within the
&lt;connector&gt; attribute. It defines a connector using port 8443. THIS IS
NOT IN USE!</p>
<p>Authentication method.</p>
<p>The IDP authentication handler can authenticate a user by one of several
authentication methods. The default Userid / Password authentication
handler is currently be used. Authentication flows are defined in
$IDP_HOME/conf/authn.</p>
<p>See
<a class="reference external" href="https://wiki.shibboleth.net/confluence/display/IDP30/AuthenticationConfiguration">https://wiki.shibboleth.net/confluence/display/IDP30/AuthenticationConfiguration</a>
for further details.</p>
<p>IDP Configuration maintained on the Milan Server</p>
<p><strong>File= /opt/shibboleth-idp/conf/idp.properties</strong></p>
<p>In this file we define the entity id of our IDP server.</p>
<p># Set the entityID of the IdP</p>
<p>idp.entityID= <a class="reference external" href="https://idp.syspertec.com/idp/shibboleth">https://idp.syspertec.com/idp/shibboleth</a> <strong>&lt;&lt;&lt; Our IDP
entity</strong></p>
<p># Set the scope used in the attribute resolver for scoped attributes</p>
<p>idp.scope= syspertec.com</p>
<p><strong>File = /opt/shibboleth-idp/attribute-filter.xml</strong></p>
<p>In this file we configure what security attributes are passed to the SP.
Within the &lt;AttributeFilterPolicyGroup&gt; the following filter policy was
added:-</p>
<p>&lt;!&#8211; Release some attributes to an SP. &#8211;&gt;</p>
<p>&lt;AttributeFilterPolicy id=&#8221;example1&#8221;&gt;</p>
<blockquote>
<div>&lt;PolicyRequirementRule xsi:type=&#8221;Requester&#8221;
value=&#8221;https://sp.syspertec.com/shibboleth&#8221; /&gt;</div></blockquote>
<p>&lt;AttributeRule attributeID=&#8221;eduPersonPrincipalName&#8221;&gt;</p>
<p>&lt;PermitValueRule xsi:type=&#8221;ANY&#8221; /&gt;</p>
<p>&lt;/AttributeRule&gt;</p>
<p>&lt;AttributeRule attributeID=&#8221;uid&#8221;&gt; <strong>&lt;&lt;&lt; Required for HTTP HEADER</strong></p>
<p>&lt;PermitValueRule xsi:type=&#8221;ANY&#8221; /&gt;</p>
<p>&lt;/AttributeRule&gt;</p>
<p>&lt;AttributeRule attributeID=&#8221;mail&#8221;&gt;</p>
<p>&lt;PermitValueRule xsi:type=&#8221;ANY&#8221; /&gt;</p>
<p>&lt;/AttributeRule&gt;</p>
<p>&lt;/AttributeFilterPolicy&gt;</p>
<p>File = Attribute-filter.xml</p>
<p>In this file we configure what security attributes are passed to the SP.
Within the &lt;AttributeFilterPolicyGroup&gt; the following filter policy was
added:-</p>
<p><strong>File = /opt/shibboleth-idp/conf/ldap.properties</strong></p>
<p>In this file we identify the LDAP server the IDP will use. We also set
the TLS security flag and identify the Java trustStore.</p>
<p>## Connection properties ##</p>
<p>idp.authn.LDAP.ldapURL = <a class="reference external" href="ldap://milan:10389">ldap://milan:10389</a> <strong>&lt;&lt;&lt; Our LDAP Server</strong></p>
<p>idp.authn.LDAP.useStartTLS = true</p>
<p>## SSL configuration, either jvmTrust, certificateTrust, or
keyStoreTrust</p>
<p>idp.authn.LDAP.sslConfig = keyStoreTrust</p>
<p>idp.authn.LDAP.trustStore = %{idp.home}/credentials/milan.jks</p>
<p><strong>File=/opt/shibboleth-idp/conf/metadata-providers.xml</strong></p>
<p>In this file we identity the location of the metadata that represents
our SP.</p>
<p>&lt;MetadataProvider xsi:type=&#8221;FilesystemMetadataProvider&#8221; id=&#8221;SPMETADATA&#8221;</p>
<p>metadataFile=&#8221;/opt/shibboleth-idp/metadata/sp-metadata.xml&#8221;/&gt;</p>
<p>&lt;/MetadataProvider&gt;</p>
<p><strong>Setting up the Service Provider V2</strong></p>
<p>SP Configuration maintained on HOLT-WIN7</p>
<p>To support the SP environment we installed the latest XAMPP tool. This
provides an Apache container from which we can use and configure
Shibboleth SP V2. The Apache Server runs as a reverse proxy redirecting
request towards Virtel.</p>
<p>SP sp.syspertec.com</p>
<p>SP_HOME (distribution) C:\opt\shibboleth-sp</p>
<p>SP Configuration files $SP_HOME\etc</p>
<p>Apache <a class="reference external" href="http://sp.syspertec.com">http://sp.syspertec.com</a> Apache Home Web Page</p>
<p>XAMPP C:\xampp\apache</p>
<p>Apache Configuration files C:\xampp\apache\conf</p>
<p>SP Configuration files C:\xampp\apache\conf\extra</p>
<p>After installing XAMPP and the Shibboleth V2 make sure that the Windows
Service is running:-</p>
<p><a class="reference internal" href="../../../_images/image514.png"><img alt="image4" src="../../../_images/image514.png" style="width: 6.26806in; height: 5.16806in;" /></a></p>
<p>Figure Shibboleth Window Service running.</p>
<p>**
Shibboleth Configuration**</p>
<p>The files modified in the Shibboleth setup for the SP are as follows:-</p>
<p><strong>File = C:\opt\shibboleth-sp\etc\Shibboleth2.xml</strong></p>
<p>This is the main shibboleth configuration file. Here are some of the
elements that were modified.</p>
<p>&lt;ApplicationDefaults entityID<strong>=https://sp.syspertec.com/shibboleth
&lt;&lt;&lt; Entity ID</strong></p>
<p>REMOTE_USER=&#8221;<strong>uid</strong> eppn persistent-id targeted-id&#8221; <strong>&lt;&lt;&lt; UID</strong>
cipherSuites=&#8221;ECDHE+AESGCM:ECDHE:!aNULL:!eNULL:!LOW:!EXPORT:!RC4:!SHA:!SSLv2&#8221;&gt;</p>
<p>……</p>
<p>&lt;SSO
entityID=<a class="reference external" href="https://idp.syspertec.com/idp/shibboleth">**https://idp.syspertec.com/idp/shibboleth**</a>
<strong>&lt;&lt;&lt; Entity ID</strong></p>
<p>discoveryProtocol=&#8221;SAMLDS&#8221;
discoveryURL=&#8221;<a class="reference external" href="https://ds.example.org/DS/WAYF">https://ds.example.org/DS/WAYF</a>&#8220;&gt;</p>
<p>SAML2 SAML1</p>
<p>&lt;/SSO&gt;</p>
<p>……</p>
<p>&lt;CredentialResolver type=&#8221;File&#8221; <strong>&lt;&lt;&lt;&lt; Server Certificate</strong></p>
<p>key=&#8221;C:\xampp\apache\conf\ssl.key\server.key&#8221;</p>
<p>certificate=&#8221;C:\xampp\apache\conf\ssl.crt\server.crt&#8221; /&gt;</p>
<p>&lt;/ApplicationDefaults&gt;</p>
<p>File = <strong>C:\opt\shibboleth-sp\etc\attribute-map.xml</strong></p>
<p>The UID attribute was uncommented in the attribute-map.xml file.</p>
<p>&#8211;&gt;</p>
<p>&lt;Attribute name=&#8221;<a class="reference external" href="urn:oid:0.9.2342.19200300.100.1.1">urn:oid:0.9.2342.19200300.100.1.1</a>&#8221; id=&#8221;uid&#8221;/&gt;</p>
<p>&lt;!—</p>
<p><strong>C:\opt\shibboleth-sp\etc\idp-metadata.XML</strong></p>
<p>Metadata file for IDP</p>
<p><strong>C:\opt\shibboleth-sp\etc\sp-metadata.XML</strong></p>
<p>Metadata file for SP.</p>
<p>**
Apache Configuration**</p>
<p><strong>File =C:\XAMPP\Apache\Conf\httpd.conf</strong></p>
<p>This is the standard Apache HTTP configuration file. In here we
configure the protected resources and configure the Shibboleth SP. The
following statements are added or modified:-</p>
<p>Set the Server name for the Apache Server</p>
<p>ServerName sp.syspertec.com:80</p>
<p>Set the required Proxy Modules</p>
<p>LoadModule proxy_module modules/mod_proxy.so</p>
<p>LoadModule proxy_ajp_module modules/mod_proxy_ajp.so</p>
<p>LoadModule proxy_balancer_module modules/mod_proxy_balancer.so</p>
<p>LoadModule proxy_connect_module modules/mod_proxy_connect.so</p>
<p>Set redirect on to support redirect request within Virtel HTTP
responses.</p>
<p>&lt;IfModule alias_module&gt;</p>
<p>#Send /w2h request to /xampp/htdocs/virtel</p>
<p>Redirect /w2h /virtel/w2h <strong>&lt;&lt;&lt; Virtel Redirect</strong></p>
<p>ScriptAlias /cgi-bin/ &#8220;C:/xampp/cgi-bin/&#8221;</p>
<p>&lt;/IfModule&gt;</p>
<p>Add the include for the Shibboleth HTTP configuration file.</p>
<p>#Shibboleth</p>
<p>#include &#8216;C:\opt\shibboleth-sp\etc\shibboleth\apache24.config&#8217;</p>
<p>include &#8220;conf/extra/httpd-shibboleth.conf</p>
<p><strong>File =C:\XAMPP\Apache\Conf\extra\httpd-shibboleth.conf</strong></p>
<p>Within this file add the location “Virtel” as a protected resource. Any
access to the Virtel application we have to be validated through the IDP
and SP interface. The SP will set the variable REMOTE_USER based upon
the IUD attribute returned by the IDP on successful validation. This
will be passed through to Virtel to use to generate a PASSTICKET. The
userid /PASSTICKET combination will be used to sign on to any secure
applications within the APPMENU list.</p>
<p># Connect using HTTPS to SPVIRSSL on ZAMVS2</p>
<p>&lt;Location /virtel&gt;</p>
<p>AuthType shibboleth</p>
<p>ShibRequestSetting requireSession 1</p>
<p>require shib-session</p>
<p>RequestHeader set SM_User %{REMOTE_USER}s <strong>&lt;&lt;&lt; = Create HTTP header</strong></p>
<p>ProxyPass <a class="reference external" href="https://192.168.171.30:41002">https://192.168.171.30:41002</a> <strong>&lt;&lt;&lt; = Secure Virtel Port</strong></p>
<p>ProxyPassReverse <a class="reference external" href="https://192.168.171.30:41002">https://192.168.171.30:41002</a> <strong>&lt;&lt;&lt; = Secure Virtel
Port</strong></p>
<p>&lt;/location&gt;</p>
<p>#</p>
<p><strong>LDAP</strong></p>
<p>The LDAP environment that was used to support the Shibboleth IDP was the
Apache Data Services LDAP offering. This was installed on the Milan
Server. Configuration of the LDAP is through the Windows Apache Data
Services client. This has to be installed on a Windows machine and then
pointed at the LDAP Server.</p>
<p>Once configured correctly, the client can access the LDAP structures and
build the necessary security attributes that the IDP will require.</p>
<p><a class="reference internal" href="../../../_images/image614.png"><img alt="image5" src="../../../_images/image614.png" style="width: 6.26806in; height: 4.69306in;" /></a></p>
<p>Figure Example of the Apache DS Client</p>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../TN201703/TN201703.html" class="btn btn-neutral float-right" title="Passticket support with CA Top Secret" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../TN201701/TN201701.html" class="btn btn-neutral" title="Protecting business assets" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Syspertec. All rights reserved.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>