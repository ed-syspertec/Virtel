%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}


\usepackage{cmap}

\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}

\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.\@ }}
\makeatletter
\def\fnum@figure{\figurename\thefigure{}}
\makeatother
\addto\captionsenglish{\renewcommand{\tablename}{Table }}
\makeatletter
\def\fnum@table{\tablename\thetable{}}
\makeatother
\addto\captionsenglish{\renewcommand{\literalblockname}{Listing}}

\addto\captionsenglish{\renewcommand{\literalblockcontinuedname}{continued from previous page}}
\addto\captionsenglish{\renewcommand{\literalblockcontinuesname}{continues on next page}}
\addto\captionsenglish{\renewcommand{\sphinxnonalphabeticalgroupname}{Non-alphabetical}}
\addto\captionsenglish{\renewcommand{\sphinxsymbolsname}{Symbols}}
\addto\captionsenglish{\renewcommand{\sphinxnumbersname}{Numbers}}

\addto\extrasenglish{\def\pageautorefname{page}}




% Enable unicode and use Courier New to ensure the card suit
% characters that are part of the 'random' module examples
% appear properly in the PDF output.
\usepackage{fontspec}
\setmonofont{Courier New}


\title{Converting a VBA macro}
\date{Jul 23, 2020}
\release{1.00}
\author{Syspertec Communications}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{Release}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{TN202001::doc}}



\chapter{Introduction}
\label{\detokenize{TN202001:introduction}}
In this newsletter we discuss how to migrate an EXCELVBA macro(s) to use VIRTEL’s scenario language and perform the same business logic. Currently, the VBA macro uses Attachmate Extra objects to establish a 3270 session and scrape the 3270 buffers. Application navigation, data validation and session management are also performed within the VBA code.  The VBA macro is driven by a EXECL spread sheet with input data fields, buttons and selection list. The idea of this migration is to maintain as much of the ‘business logic’ of the original macro as possible and only replace the 3270 communication processes with equivalent Virtel APIs.


\chapter{Overview of the business process}
\label{\detokenize{TN202001:overview-of-the-business-process}}
The business process provides extraction of data for the following: -
- Customer Profile
- Loan Accounts
- Deposit Accounts

In this POC, only Customer Profile information is considered. Three environments HOGV,HOGS and HOGL are CICS regions that can be accessed to provide the CICS interface. These interfaces are defined as Virtel transactions, each one accessing a CICS system. Again, this POC accesses the same CICS system. See transactions CLI-13A, CLI-13B and CLI13-C.


\chapter{Virtel Configuration}
\label{\detokenize{TN202001:virtel-configuration}}
Three transactions are defined to represent the three CICS environments.

\sphinxincludegraphics{{image1}.png}

The detail of each transaction is shown below :-

\sphinxincludegraphics{{image2}.png}

The current VBA code maintains all of the MVC (model, view, controller) architecture. With the Virtel solution, the model and controller elements are moved to the supporting scenario, SCENPENF, which runs within the Virtel address space. The scenario is shown in Appendix A. The Virtel input scenario, SCENPENF, is associated with each transaction. This scenario now becomes the Model and Controller of the new MVC architecture, with the VBA code now only providing the View component. Navigational and data extraction are now handled by the scenario, whereas before, it was done in the VBA module.


\chapter{Logic overview}
\label{\detokenize{TN202001:logic-overview}}
A series of customer numbers is entered manually on the left-hand side. These match up with customer numbers in the CICS application transaction MENU. This application is used to simulate a CICS transaction extracting customer data.  These customer data inquiries are sent to the mainframe via a HTTP requests within VBA using the MSXML2.XMLHTTP object.   A Virtel VBA Class is used to contain all the necessary HTTP code required to support the operation. A Virtel object is created, based upon the Virtel Class, and is used for communicating between the Virtel STC running on the mainframe and the supporting VBA Module.

The first time the VBA module is called, security credentials are obtained through two VBA InputBox calls :-

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{userid} \PYG{o}{=} \PYG{n}{InputBox}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enter your mainframe Userid}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{password} \PYG{o}{=} \PYG{n}{InputBox}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enter your mainframe Password}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

The IP address and PORT information for Virtel are held in two Public Constants at the beginning of the VBA Module 1.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{Public} \PYG{n}{Const} \PYG{n}{host} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{192.168.170.48}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{\PYGZus{}}
            \PYG{n}{port} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{41002}\PYG{l+s+s2}{\PYGZdq{}}
\end{sphinxVerbatim}

Each time an inquiry is made a HTTP request is sent to Virtel. The request contains all the information needed by the Virtel scenario SCENPENF with the scenario extracting data from the URL. The extracted data is used to perform the following business logic in the Virtel scenario :-
\begin{itemize}
\item {} 
Logon to CICS

\item {} 
Navigate through to the detail Customer Inquiry panel.

\item {} 
Extract Name, Address1 and City from the screen buffer

\item {} 
Create a response in the form of a CSV string :- name; address1; city

\item {} 
Send the response back to the outstanding HTTP request.

\end{itemize}

An example of the URL generated by the VBA Virtel object is below :-

\begin{sphinxVerbatim}[commandchars=\\\{\}]
http://192.168.170.48:41002/w2h/WEB2AJAX.htm+HOGL?userName=sptholt\PYGZam{}password=pw\PYGZam{}trans=MENU\PYGZam{}custNo=105226
\end{sphinxVerbatim}

The response data returned is in the form of a CSV string containing name, address1 and city. This information is then used to populate a second worksheet, CUPR. The next two diagrams show the input Excel object worksheet 1

\sphinxincludegraphics{{image3}.png}

The output Excel worksheet CUPR, is used to display the customer information extracted from the CSV response string. Note that only three fields are populated, those being Name, Address1, and City :-

\sphinxincludegraphics{{image4}.png}


\chapter{Menu Legacy Application}
\label{\detokenize{TN202001:menu-legacy-application}}
The legacy application that is used to provide the data is a simple CICS invoice system. A sample of the relevant input screens are shown below. First the Master menu.

\sphinxincludegraphics{{image5}.png}

Next, the customer inquiry screen : -

\sphinxincludegraphics{{image6}.png}

And finally, the customer detail screen.

\sphinxincludegraphics{{image7}.png}

It is from this screen that we navigate to within the Virtel scenario and then extract the Name, Address1 and City and return that data to the VBA code which is then used to populate the CUPR work sheet.


\chapter{Overview of the SCENPENF scenario}
\label{\detokenize{TN202001:overview-of-the-scenpenf-scenario}}
The SCENPENF scenario performs the following functions after establishing a session with the CICS environment.

\sphinxstylestrong{Entry : {[}Extract data from URL{]}}
\begin{enumerate}
\def\theenumi{\arabic{enumi}}
\def\labelenumi{\theenumi .}
\makeatletter\def\p@enumii{\p@enumi \theenumi .}\makeatother
\item {} 
Extract the following fields from the URL and place them into variables: -
\begin{itemize}
\item {} 
userName   =\textgreater{}      userName

\item {} 
password   =\textgreater{}      password

\item {} 
trans      =\textgreater{}      trans           CICS transaction

\item {} 
custNo     =\textgreater{}      custNo          Customer Number

\end{itemize}

\item {} 
GoTo LOGON

\end{enumerate}

\sphinxstylestrong{Label:        LOGON  {[}Sign on processing{]}}
\begin{enumerate}
\def\theenumi{\arabic{enumi}}
\def\labelenumi{\theenumi .}
\makeatletter\def\p@enumii{\p@enumi \theenumi .}\makeatother
\item {} 
Copy the userName and password into the CICS sign on screen

\item {} 
Send Enter to the CICS application, check application for message DFHCE3549; signOn complete message.

\item {} 
Goto START

\end{enumerate}

\sphinxstylestrong{Label : START {[}Screen Navigation{]}}
\begin{enumerate}
\def\theenumi{\arabic{enumi}}
\def\labelenumi{\theenumi .}
\makeatletter\def\p@enumii{\p@enumi \theenumi .}\makeatother
\item {} 
Copy the CICS transaction variable trans to CICS screen.

\item {} 
Send Enter to the CICS application and wait for buffer with characters ‘MENMAP1’

\item {} 
Call DOREGION sub-routine. Test return screen for any errors.

\item {} 
Copy value=’1’ to location in 3270 buffer at line 5, column 27, for a length of 1.

\item {} 
Send Enter to the CICS application and wait for buffer with characters ‘INQMAP3’

\item {} 
Copy the custNo variable into the CICS screen at location row 5, column 27, for a length of 7.

\item {} 
Call GETDATA sub-routine.

\item {} 
Goto SENDMSG

\end{enumerate}

\sphinxstylestrong{Label : SENDMSG \{Build OK response message{]}}
\begin{enumerate}
\def\theenumi{\arabic{enumi}}
\def\labelenumi{\theenumi .}
\makeatletter\def\p@enumii{\p@enumi \theenumi .}\makeatother
\item {} 
Create list variable concatenation string OK: with variable Message

\item {} 
GoTo RETURN\_RSP

\end{enumerate}

\sphinxstylestrong{Label : RETURN\_RSP {[}Send Response to browser{]}}
\begin{enumerate}
\def\theenumi{\arabic{enumi}}
\def\labelenumi{\theenumi .}
\makeatletter\def\p@enumii{\p@enumi \theenumi .}\makeatother
\item {} 
Terminate 3270 session with CICS

\item {} 
Convert response buffer from EBCDIC to ASCII

\item {} 
Send response back to browser.

\item {} 
Disconnect Virtel Session

\item {} 
End scenario

\end{enumerate}

\sphinxstylestrong{Label : GETDATA {[}Build response buffer from 3270 buffer{]}}
\begin{enumerate}
\def\theenumi{\arabic{enumi}}
\def\labelenumi{\theenumi .}
\makeatletter\def\p@enumii{\p@enumi \theenumi .}\makeatother
\item {} 
Copy data from screen and place into variables name1, name2, addr1, addr2

\item {} 
Build CSV Message buffer, concatenating variables name2,name1,addr1,addr2 and trim and blanks. String will look like: ‘Lennon,John;Penny Lane;Liverpool’.

\item {} 
Return to call

\end{enumerate}

\sphinxstylestrong{Label : DOREGION {[}Example of validation and navigation of a 3270 screen  buffer{]}}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{REGN0} \PYG{n}{EQU} \PYG{o}{*}
\PYG{n}{If} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{12}\PYG{p}{)} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{6.5 SWIFTSEC}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{then}
\PYG{n}{REGN1}        \PYG{n}{EQU} \PYG{o}{*}
   \PYG{n}{If} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{17}\PYG{p}{)} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Opened Sessions}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{then}
      \PYG{n}{COPY} \PYG{n}{value} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{to} \PYG{n}{location} \PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,}\PYG{l+m+mi}{10}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}
      \PYG{n}{Send} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enter}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{to} \PYG{n}{application}
      \PYG{n}{GOTO} \PYG{n}{REGN1}
   \PYG{n}{Else}
      \PYG{n}{GOTO} \PYG{n}{REGN2}
\PYG{n}{Else}
   \PYG{n}{GOTO} \PYG{n}{REGN3}
\PYG{n}{REGN2}        \PYG{n}{EQU} \PYG{o}{*}
   \PYG{n}{SEND} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PA2}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{to} \PYG{n}{application}
\PYG{n}{REGN2A} \PYG{n}{EQU} \PYG{o}{*}
   \PYG{n}{If} \PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{17}\PYG{p}{)} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Application List}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{then}
      \PYG{n}{COPY} \PYG{n}{value} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{to} \PYG{n}{location} \PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,}\PYG{l+m+mi}{10}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}
      \PYG{n}{Send} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Enter}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{to} \PYG{n}{application}
      \PYG{n}{GOTO} \PYG{n}{REGN2A}
   \PYG{n}{Else}
      \PYG{n}{GOTO} \PYG{n}{REGN4}
\PYG{n}{REGN3} \PYG{n}{EQU} \PYG{o}{*}
   \PYG{n}{SEND} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{PA2}\PYG{l+s+s2}{\PYGZdq{}} \PYG{n}{to} \PYG{n}{application}
   \PYG{n}{GOTO} \PYG{n}{REGN0}
\PYG{n}{REGN4} \PYG{n}{EQU} \PYG{o}{*}
   \PYG{n}{Return} \PYG{n}{to} \PYG{n}{caller}
\end{sphinxVerbatim}

\sphinxstylestrong{Error handling}

The error handling is very basic. For example, invalid credentials and other errors will be reported as a HTML message:-

\sphinxincludegraphics{{image8}.png}

An invalid customer number will return no data. See 999999 :-

\sphinxincludegraphics{{image9}.png}

If the CICS system is not available, you will get the following error reported :-

\sphinxincludegraphics{{image10}.png}

This error will also occur if you are signed onto CICS with your credentials through another Virtel session.


\chapter{Appendix A}
\label{\detokenize{TN202001:appendix-a}}

\section{Scenario SCENPENF}
\label{\detokenize{TN202001:scenario-scenpenf}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
SCENPENF SCREENS APPL=SCENPENF
*\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}
*\PYGZsh{}\PYGZsh{}                         INPUT SCENARIO                           \PYGZsh{}\PYGZsh{}
*\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}
*
         SCENARIO INPUT
         DEBUG\PYGZdl{} TRACE,SCENARIO
         IF\PYGZdl{} SESSION\PYGZhy{}SWITCH,THEN=RESUME
* Look for message DFHCE3520 (Please type your userid)
         IF\PYGZdl{}  (23,02,09),EQ=\PYGZsq{}DFHCE3520\PYGZsq{},ELSE=EXIT
*
         COPY\PYGZdl{} INPUT\PYGZhy{}TO\PYGZhy{}VARIABLE,FIELD=\PYGZsq{}userName\PYGZsq{},VAR=\PYGZsq{}userName\PYGZsq{}
         IF\PYGZdl{}   NOT\PYGZhy{}FOUND,THEN=PARAM\PYGZus{}ERR\PYGZus{}USER
         COPY\PYGZdl{} INPUT\PYGZhy{}TO\PYGZhy{}VARIABLE,FIELD=\PYGZsq{}password\PYGZsq{},VAR=\PYGZsq{}password\PYGZsq{}
         IF\PYGZdl{}   NOT\PYGZhy{}FOUND,THEN=PARAM\PYGZus{}ERR\PYGZus{}PWD
         COPY\PYGZdl{} INPUT\PYGZhy{}TO\PYGZhy{}VARIABLE,FIELD=\PYGZsq{}trans\PYGZsq{},VAR=\PYGZsq{}trans\PYGZsq{}
         IF\PYGZdl{}   NOT\PYGZhy{}FOUND,THEN=PARAM\PYGZus{}ERR\PYGZus{}TRANS
         COPY\PYGZdl{} INPUT\PYGZhy{}TO\PYGZhy{}VARIABLE,FIELD=\PYGZsq{}custNo\PYGZsq{},VAR=\PYGZsq{}custNo\PYGZsq{}
         IF\PYGZdl{}   NOT\PYGZhy{}FOUND,THEN=PARAM\PYGZus{}ERR\PYGZus{}CUSTNO,ELSE=LOGON
*
PARAM\PYGZus{}ERR\PYGZus{}USER EQU *
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=\PYGZsq{}Missing required parameter (userName)\PYGZsq{}
         GOTO\PYGZdl{} ERRORMSG
*
PARAM\PYGZus{}ERR\PYGZus{}PWD EQU   *
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=\PYGZsq{}Missing required parameter (password)\PYGZsq{}
         GOTO\PYGZdl{} ERRORMSG
*
PARAM\PYGZus{}ERR\PYGZus{}TRANS EQU   *
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=\PYGZsq{}Missing required parameter (trans)\PYGZsq{}
         GOTO\PYGZdl{} ERRORMSG
*
PARAM\PYGZus{}ERR\PYGZus{}CUSTNO EQU   *
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=ErrorMsg,TYPE=REPLACE,            *
               VALUE=\PYGZsq{}Missing required parameter (custNo)\PYGZsq{}
         GOTO\PYGZdl{} ERRORMSG
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
RESUME   EQU   *
         IF\PYGZdl{}   (01,01,07),EQ=\PYGZsq{}APO00PG\PYGZsq{},THEN=DOEXIT
         IF\PYGZdl{}   (22,01,12),EQ=\PYGZsq{}P3\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}P4\PYGZsq{},THEN=DOP4
         IF\PYGZdl{}   (01,02,04),EQ=\PYGZsq{}MENU\PYGZsq{},THEN=DOCLEAR
         IF\PYGZdl{}   (01,02,01),EQ=\PYGZsq{}X\PYGZsq{},THEN=DOP3
         IF\PYGZdl{}   (01,01,34),EQ=\PYGZsq{}MENU123I Error: session terminated\PYGZsq{},     x
               THEN=DOEXIT,ELSE=DOP3
         SCENARIO END
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
LOGON    EQU   *
         COPY\PYGZdl{} VARIABLE\PYGZhy{}TO\PYGZhy{}SCREEN,VAR=\PYGZsq{}userName\PYGZsq{},SCREEN=(10,26,08)
         COPY\PYGZdl{} VARIABLE\PYGZhy{}TO\PYGZhy{}SCREEN,VAR=\PYGZsq{}password\PYGZsq{},SCREEN=(11,26,08)
*    Send to application
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D
*
*    on message DFHCE3549 (Signon is complete), press CLEAR SCREEN
         IF\PYGZdl{}   (24,02,09),EQ=\PYGZsq{}DFHCE3549\PYGZsq{},ELSE=EXIT
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=6D
         GOTO\PYGZdl{} START*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
SENDMSG  DS   0H
         COPY\PYGZdl{} LIST\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=\PYGZsq{}response\PYGZsq{},TYPE=REPLACE,           *
               LIST=(\PYGZsq{}OK:\PYGZsq{},\PYGZsq{}*Message\PYGZsq{})
         GOTO\PYGZdl{} RETURN\PYGZus{}RSP
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
START    DS   0H
         ERROR\PYGZdl{} 0,\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{} START\PYGZsq{}
         COPY\PYGZdl{} VARIABLE\PYGZhy{}TO\PYGZhy{}SCREEN,VAR=\PYGZsq{}trans\PYGZsq{},SCREEN=(01,01,04)
               ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D,                         *
               AND=(WAIT,\PYGZsq{}MENMAP1\PYGZsq{})
         PERFORM\PYGZdl{} DOREGION
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}SCREEN,VALUE=\PYGZsq{}1\PYGZsq{},SCREEN=(05,17,01)
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D,                               *
               AND=(WAIT,\PYGZsq{}INQMAP3\PYGZsq{})
         COPY\PYGZdl{} VARIABLE\PYGZhy{}TO\PYGZhy{}SCREEN,VAR=\PYGZsq{}custNo\PYGZsq{},SCREEN=(05,27,07)
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D
         PERFORM\PYGZdl{} GETDATA
         GOTO\PYGZdl{} SENDMSG
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
DOLOGOFF DS   0H
         PERFORM\PYGZdl{} TRACE
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}SCREEN,VALUE=\PYGZsq{}CESF\PYGZsq{},                           *
               SCREEN=(1,1,4),TYPE=ERASE\PYGZhy{}FIELD
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D,           SEND CESF           *
               AND=(WAIT,\PYGZsq{}DFHCE3590\PYGZsq{}),                                 *
               MAXTIME=500
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D            SEND ENTER
         ACTION\PYGZdl{} TERMSESS                          KILL SESSION
*
* Send any response back to browser
*
         CONVERT\PYGZdl{} EBCDIC\PYGZhy{}TO\PYGZhy{}ASCII,VAR=\PYGZsq{}response\PYGZsq{},TABLE=\PYGZsq{}IBM1147\PYGZsq{}
         SEND\PYGZdl{} AS\PYGZhy{}ANSWER,VAR=\PYGZsq{}response\PYGZsq{},TYPE=\PYGZsq{}text/plain\PYGZsq{},             *
               EXPIRES=IMMEDIATELY
         DEBUG\PYGZdl{} NOTRACE,SCENARIO
         SCENARIO END
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
DOCLEAR  DS   0H
         ERROR\PYGZdl{} 0,\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{} DOCLEAR\PYGZsq{}
* Send CLEAR to exit from the application
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=6D
         GOTO\PYGZdl{} RESUME
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
DOP3     DS   0H
         ERROR\PYGZdl{} 0,\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{} DOP3\PYGZsq{}
* Send PF3 to go back to previous menu within the application
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=F3
         GOTO\PYGZdl{} RESUME
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
DOP4     DS   0H
         ERROR\PYGZdl{} 0,\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{} DOP4\PYGZsq{}
* Send PF4 to exit from the application
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=F4
         GOTO\PYGZdl{} RESUME
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
DOEXIT   DS   0H
         ERROR\PYGZdl{} 0,\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{} DOEXIT\PYGZsq{}
* Send CLEAR before starting new transaction
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=6D
         GOTO\PYGZdl{} START
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
EXIT     EQU   *
         ERROR\PYGZdl{} 0,\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{} EXIT\PYGZsq{}
         SCENARIO END
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
*
*\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}
*\PYGZsh{}\PYGZsh{}                          H E L P E R S                           \PYGZsh{}\PYGZsh{}
*\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}
*
ERRORMSG EQU   *
         COPY\PYGZdl{} LIST\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=\PYGZsq{}response\PYGZsq{},TYPE=REPLACE,           *
               LIST=(\PYGZsq{}KO:\PYGZsq{},\PYGZsq{}*ErrorMsg\PYGZsq{})
         GOTO\PYGZdl{} RETURN\PYGZus{}RSP
*\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}
RETURN\PYGZus{}RSP  EQU *
         ACTION\PYGZdl{} TERMSESS
         CONVERT\PYGZdl{} EBCDIC\PYGZhy{}TO\PYGZhy{}ASCII,VAR=\PYGZsq{}response\PYGZsq{},TABLE=\PYGZsq{}IBM1147\PYGZsq{}
         SEND\PYGZdl{} AS\PYGZhy{}ANSWER,VAR=\PYGZsq{}response\PYGZsq{},TYPE=\PYGZsq{}text/plain\PYGZsq{},             *
               EXPIRES=IMMEDIATELY
         DEBUG\PYGZdl{} NOTRACE,SCENARIO
         ERROR\PYGZdl{} 0,\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{} DISCONNECT\PYGZsq{}
         ACTION\PYGZdl{} DISCONNECT
         SCENARIO END
*
*\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}
*\PYGZsh{}\PYGZsh{}                        OUTPUT SCENARIO                           \PYGZsh{}\PYGZsh{}
*\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}
*
         SCENARIO OUTPUT
         SCENARIO END
*
*****************
*** GETDATA   ***
*****************
GETDATA  SCENARIO SUBROUTINE
         COPY\PYGZdl{} SCREEN\PYGZhy{}TO\PYGZhy{}VARIABLE,SCREEN=(07,27,16),VAR=name1,         *
               TYPE=REPLACE
         COPY\PYGZdl{} SCREEN\PYGZhy{}TO\PYGZhy{}VARIABLE,SCREEN=(08,27,16),VAR=name2,         *
               TYPE=REPLACE
         COPY\PYGZdl{} SCREEN\PYGZhy{}TO\PYGZhy{}VARIABLE,SCREEN=(09,27,30),VAR=addr1,         *
               TYPE=REPLACE
         COPY\PYGZdl{} SCREEN\PYGZhy{}TO\PYGZhy{}VARIABLE,SCREEN=(10,27,16),VAR=addr2,         *
               TYPE=REPLACE
         COPY\PYGZdl{} LIST\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=\PYGZsq{}message\PYGZsq{},TYPE=REPLACE,            *
               LIST=(\PYGZsq{}*name2\PYGZsq{},\PYGZsq{},\PYGZsq{},\PYGZsq{}*name1\PYGZsq{},\PYGZsq{};\PYGZsq{},                        *
               \PYGZsq{}*addr1\PYGZsq{},\PYGZsq{};\PYGZsq{},\PYGZsq{}*addr2\PYGZsq{}),                                 *
               LTRIM=(\PYGZsq{} \PYGZsq{}),RTRIM=(\PYGZsq{} \PYGZsq{})
         SCENARIO END
*
*****************
*** DOREGION  ***
*****************
DOREGION SCENARIO SUBROUTINE
REGN0    LABEL\PYGZdl{}
         IF\PYGZdl{}   (01,01,12),EQ=\PYGZdq{}6.5 SWIFTSEC\PYGZdq{},ELSE=REGN3
*    loop through Session Selection
REGN1    LABEL\PYGZdl{}
         IF\PYGZdl{}   (04,02,17),EQ=\PYGZsq{}Opened Sessions \PYGZsq{},ELSE=REGN2
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}SCREEN,VALUE=\PYGZsq{}C\PYGZsq{},SCREEN=(05,10,01)
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D
         GOTO\PYGZdl{} REGN1
*    loop through Application List. Send PA2 first
REGN2    LABEL\PYGZdl{}
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=6E
REGN2A   LABEL\PYGZdl{}
         IF\PYGZdl{}   (04,02,17),EQ=\PYGZsq{}Application List \PYGZsq{},ELSE=REGN4
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}SCREEN,VALUE=\PYGZsq{}C\PYGZsq{},SCREEN=(05,10,01)
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=7D
         GOTO\PYGZdl{} REGN2A
REGN3    LABEL\PYGZdl{}
* Send PA2 and start again.
         ACTION\PYGZdl{}  TO\PYGZhy{}APPLICATION,KEY=6E
         GOTO\PYGZdl{} REGN0
REGN4    LABEL\PYGZdl{}
         SCENARIO END
*****************
***  TRACE    ***
*****************
TRACE    SCENARIO SUBROUTINE
*
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=\PYGZsq{}ruler1\PYGZsq{},                         X
               VALUE=\PYGZsq{}\PYGZhy{}\PYGZhy{}\PYGZhy{}  0\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 10\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 20\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 30\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 40\PYGZhy{}\PYGZhy{}\PYGZhy{}X
               \textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 50\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 60\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 70\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZhy{}\PYGZhy{}\PYGZhy{} 80\PYGZhy{}\PYGZhy{}\PYGZhy{}\textbar{}\PYGZsq{},             X
               TYPE=REPLACE
         COPY\PYGZdl{} VALUE\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=\PYGZsq{}ruler2\PYGZsq{},                         X
               VALUE=\PYGZsq{}123456789\textbar{}123456789\textbar{}123456789\textbar{}123456789\textbar{}123456789X
               \textbar{}123456789\textbar{}123456789\textbar{}123456789\textbar{}123456789\textbar{}\PYGZsq{},             X
               TYPE=REPLACE
         ERROR\PYGZdl{} 0,\PYGZsq{}          \PYGZsq{},\PYGZsq{}*ruler1\PYGZsq{}
         ERROR\PYGZdl{} 0,\PYGZsq{}          \PYGZsq{},\PYGZsq{}*ruler2\PYGZsq{}

LOOP1    FOREACH\PYGZdl{} VALUE\PYGZhy{}IN\PYGZhy{}SCREEN,SCREEN=(1,1,80,24)
         COPY\PYGZdl{} SCREEN\PYGZhy{}TO\PYGZhy{}VARIABLE,SCREEN=(=,01,80),VAR=\PYGZsq{}screenL\PYGZsq{},      X
               TYPE=REPLACE
         COPY\PYGZdl{} SYSTEM\PYGZhy{}TO\PYGZhy{}VARIABLE,VAR=\PYGZsq{}L1\PYGZsq{},LENGTH=2,                   *
               FIELD=(VALUE\PYGZhy{}OF,CURRENT\PYGZhy{}LINE),TYPE=REPLACE
         ERROR\PYGZdl{} 0,\PYGZsq{}line \PYGZsq{},\PYGZsq{}*L1\PYGZsq{},\PYGZsq{}== \PYGZsq{},\PYGZsq{}*screenL\PYGZsq{}
         ENDFOR\PYGZdl{} LOOP1
*
ENDTRACE LABEL\PYGZdl{}
         POP\PYGZdl{} VAR=\PYGZsq{}screenL\PYGZsq{}
         SCENARIO END
         SCRNEND
*
         END
\end{sphinxVerbatim}


\chapter{Appendix B}
\label{\detokenize{TN202001:appendix-b}}

\section{Sample of a generic Virtel VBA Class}
\label{\detokenize{TN202001:sample-of-a-generic-virtel-vba-class}}
The following is a sample Virtel class that was used in the POC. Note that not all variables, functions, sub-routines are applicable. Some may not be used in the POC or are for debugging purposes only.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Option Explicit

\PYGZsq{}=============================================================================================
\PYGZsq{}=============================================================================================\PYGZsq{}
\PYGZsq{}   Constants
\PYGZsq{}
\PYGZsq{}=============================================================================================
\PYGZsq{}=============================================================================================

Private Const g\PYGZus{}virtelHostRange As String = \PYGZdq{}F2\PYGZdq{}            \PYGZsq{} 1 cell
Private Const g\PYGZus{}virtelPortRange As String = \PYGZdq{}F3\PYGZdq{}            \PYGZsq{} 1 cell
Private Const g\PYGZus{}userNameRange As String = \PYGZdq{}C2\PYGZdq{}              \PYGZsq{} 1 cell (login user name)
Private Const g\PYGZus{}userPassRange As String = \PYGZdq{}C3\PYGZdq{}              \PYGZsq{} 1 cell (login password)
Private Const g\PYGZus{}DSNameRange As String = \PYGZdq{}F5\PYGZdq{}                \PYGZsq{} 1 cell (requested DSName)
Private Const g\PYGZus{}Environment As String = \PYGZdq{}D3\PYGZdq{}                \PYGZsq{} 1 cell Environment
Private Const g\PYGZus{}Profile As String = \PYGZdq{}D4\PYGZdq{}                    \PYGZsq{} 1 cell Profile

Private Const g\PYGZus{}urlParamsRange As String = \PYGZdq{}B10:C1000\PYGZdq{}      \PYGZsq{} 2 columns (name/value)
Private Const g\PYGZus{}responseRange As String = \PYGZdq{}F10:F500\PYGZdq{}
Private Const g\PYGZus{}responseCols As Long = 6

Private Const g\PYGZus{}baseUrl As String = \PYGZdq{}/w2h/WEB2AJAX.htm+\PYGZdq{}

Private Const g\PYGZus{}markerEOL As String = \PYGZdq{}/\PYGZsh{}\PYGZdq{}

Private Const g\PYGZus{}ScreenTag As String = \PYGZdq{}(*SCREEN*)\PYGZdq{}
Private Const g\PYGZus{}ScreenColumn As Integer = 2
Private Const g\PYGZus{}ScreenRow As Integer = 1
Private Const g\PYGZus{}ScreenMsgRange As String = \PYGZdq{}B26\PYGZdq{}

Private Const g\PYGZus{}DEBUG\PYGZus{}IN As Boolean = False
Private Const g\PYGZus{}DEBUG\PYGZus{}OUT As Boolean = False

Private Const g\PYGZus{}TRACE\PYGZus{}FILE As String = \PYGZdq{}C:\PYGZbs{}Virtel\PYGZbs{}response.txt\PYGZdq{}
Private Const g\PYGZus{}SCREEN\PYGZus{}FILE As String = \PYGZdq{}C:\PYGZbs{}Virtel\PYGZbs{}screen.txt\PYGZdq{}

\PYGZsq{}=============================================================================================
\PYGZsq{}=============================================================================================
\PYGZsq{}
\PYGZsq{}   Top\PYGZhy{}level MACROS for Excel
\PYGZsq{}
\PYGZsq{}=============================================================================================
\PYGZsq{}=============================================================================================

\PYGZsq{} \PYGZhy{} MACRO \PYGZhy{}
\PYGZsq{} \PYGZgt{} Performs a POST HTTP request on the generated URL,
\PYGZsq{} \PYGZgt{} Returns received content (if successful)
\PYGZsq{}
Sub ProcessHTTP(usrName As String, usrPass As String, baseURL As String, content As String, message As String, state As Integer, system As String, transaction As String, custNo As String)
   Dim prms As String
   Dim body As String
   Dim url As String


   baseURL = buildBaseUrl(g\PYGZus{}baseUrl, usrName, usrPass, system, transaction, custNo)
   url = buildURL(baseURL, prms)
   body = \PYGZdq{}\PYGZdq{}

   \PYGZsq{} Send the HTTP request, and get back the received content
   content = sendHttpRequest(url, , body, usrName, usrPass)
End Sub


\PYGZsq{} \PYGZhy{} MACRO \PYGZhy{} [DEBUG] \PYGZhy{}
\PYGZsq{} Displays the generated URL
\PYGZsq{}
Sub ShowURL()

   Dim url As String
   Dim res As String

   url = buildURL(buildBaseUrl(g\PYGZus{}baseUrl), buildUrlParams(g\PYGZus{}urlParamsRange))
   res = \PYGZdq{}The generated URL is :\PYGZdq{} \PYGZam{} vbCrLf \PYGZam{} vbCrLf \PYGZam{} \PYGZdq{}[\PYGZdq{} \PYGZam{} url \PYGZam{} \PYGZdq{}]\PYGZdq{}

   MsgBox res

End Sub


\PYGZsq{}=============================================================================================
\PYGZsq{}=============================================================================================
\PYGZsq{}
\PYGZsq{}   Functions and subs
\PYGZsq{}
\PYGZsq{}=============================================================================================
\PYGZsq{}=============================================================================================

\PYGZsq{} Extract the meaningful data lines from the received body, and store them into
\PYGZsq{} the output lines array. This array size is dynamically adjusted to hold any amount of entries.
\PYGZsq{} The last entry in this array is always followed by an empty marker entry.
\PYGZsq{}
Function extractDataFromResponse(ByVal content As String, ByRef lines() As String) As Long

   ReDim lines(17)

   Dim nbLines As Long
   Dim startIdx As Long
   Dim nextIdx As Long
   Dim stopIdx As Long
   Dim line As String

   startIdx = 4
   nbLines = 0

   Do
      line = Trim(Mid(content, startIdx, startIdx + 69))
      lines(nbLines) = line
      nbLines = nbLines + 1
      startIdx = startIdx + 69 + 3

   Loop While (nbLines \PYGZlt{} 17)

   extractDataFromResponse = nbLines

End Function


\PYGZsq{} Perform a synchronous HTTP request on the specified URL (using the specified body)
\PYGZsq{} If an error occurs, this function returns an empty string.
\PYGZsq{} Otherwise, it returns the body as recieved from the host.
\PYGZsq{}
Function sendHttpRequest(ByVal url As String, \PYGZus{}
                        Optional ByVal mode As String = \PYGZdq{}POST\PYGZdq{}, \PYGZus{}
                        Optional ByVal body As String = \PYGZdq{}\PYGZdq{}, \PYGZus{}
                        Optional ByVal userName As String = \PYGZdq{}\PYGZdq{}, \PYGZus{}
                        Optional ByVal password As String = \PYGZdq{}\PYGZdq{}) As String

   If (g\PYGZus{}DEBUG\PYGZus{}IN) Then
      Call MsgBox(url \PYGZam{} vbCrLf \PYGZam{} vbCrLf \PYGZam{} body, vbOKOnly, \PYGZdq{}HTTP Request\PYGZdq{})
   End If

   Dim http As Object
   Set http = CreateObject(\PYGZdq{}MSXML2.XMLHTTP\PYGZdq{})

   http.Open mode, url, False, userName, password
   http.setRequestHeader \PYGZdq{}User\PYGZhy{}Agent\PYGZdq{}, \PYGZdq{}Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)\PYGZdq{}
\PYGZsq{}   http.setRequestHeader \PYGZdq{}Content\PYGZhy{}type\PYGZdq{}, \PYGZdq{}application/x\PYGZhy{}www\PYGZhy{}form\PYGZhy{}urlencoded\PYGZdq{}
   http.setRequestHeader \PYGZdq{}Content\PYGZhy{}type\PYGZdq{}, \PYGZdq{}text/plain\PYGZdq{}
   http.Send (body)

   sendHttpRequest = validateHttpResponse(http)

   If (g\PYGZus{}DEBUG\PYGZus{}OUT And (sendHttpRequest \PYGZlt{}\PYGZgt{} \PYGZdq{}\PYGZdq{})) Then
      Dim size As Long
      size = Len(sendHttpRequest)
      Call MsgBox(sendHttpRequest, , \PYGZdq{}SUCCESS \PYGZhy{} Received \PYGZdq{} \PYGZam{} size \PYGZam{} \PYGZdq{} bytes\PYGZdq{})
   End If

End Function


\PYGZsq{} Returns eihter an empty string if the HTTP response status is not 200 (and display the error message),
\PYGZsq{} or the received content otherwise.
\PYGZsq{}
Function validateHttpResponse(http As Object) As String

   Dim text As String
   Dim resText As String

   Call saveText(g\PYGZus{}TRACE\PYGZus{}FILE, http.responseText)

   resText = saveScreenAndExtractText(g\PYGZus{}SCREEN\PYGZus{}FILE, http.responseText)

   text = getHttpErrorText(http)
   If (text \PYGZlt{}\PYGZgt{} \PYGZdq{}\PYGZdq{}) Then
      text = text \PYGZam{} vbCrLf \PYGZam{} \PYGZdq{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZdq{} \PYGZam{} vbCrLf \PYGZam{} http.responseText
      MsgBox text, , \PYGZdq{}HTTP Request FAILED\PYGZdq{}
      validateHttpResponse = \PYGZdq{}\PYGZdq{}
      Exit Function
   End If

   text = resText
   If (Left(text, 3) = \PYGZdq{}OK:\PYGZdq{}) Then
      text = Mid(text, 4)
      validateHttpResponse = text
      Exit Function
   End If

   If (Left(text, 3) = \PYGZdq{}KO:\PYGZdq{}) Then
      text = \PYGZdq{}Applicative Error :\PYGZdq{} \PYGZam{} vbCrLf \PYGZam{} vbCrLf \PYGZam{} Mid(text, 4)
   Else
      text = text \PYGZam{} vbCrLf \PYGZam{} \PYGZdq{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZus{}\PYGZdq{} \PYGZam{} vbCrLf \PYGZam{} resText
   End If

   MsgBox text, , \PYGZdq{}Request Failure\PYGZdq{}
   validateHttpResponse = \PYGZdq{}\PYGZdq{}

End Function


\PYGZsq{} Perform a synchronous HTTP request on the specified URL (using the specified body)
\PYGZsq{} If an error occurs, this function returns an empty string.
\PYGZsq{} Otherwise, it returns the body as recieved from the host.
\PYGZsq{}
Function handleHttpResponse(ByVal content As String) As Boolean

   Dim lines() As String
\PYGZsq{}    Dim line As String
   Dim cell As Range
   Dim idx As Long
   Dim nbLines As Long

   nbLines = extractDataFromResponse(content, lines)

   For Each cell In ActiveSheet.Range(g\PYGZus{}responseRange).cells
\PYGZsq{}        line = lines(idx)
      If (idx = nbLines) Then Exit For
      Call injectResponseLine(cell, lines(idx))
\PYGZsq{}        cell.Value = line
      idx = idx + 1
   Next

   handleHttpResponse = True   \PYGZsq{} successful

End Function

Sub injectResponseLine(ByVal cell As Range, line As String)

   Dim col As Long
   Dim row As Long
   row = cell.row
   col = cell.Column

   ActiveSheet.cells(row, col + 0).Value = RTrim(Mid(line, 1, 8))               \PYGZsq{} Name
   ActiveSheet.cells(row, col + 2).Value = LTrim(Mid(line, 20, 8))              \PYGZsq{} Size
   ActiveSheet.cells(row, col + 3).Value = RTrim(Mid(line, 30, 11))             \PYGZsq{} Created
   ActiveSheet.cells(row, col + 4).Value = RTrim(Mid(line, 44, 18))             \PYGZsq{} Changed
   ActiveSheet.cells(row, col + 5).Value = RTrim(Mid(line, 63, 7))              \PYGZsq{} ID

End Sub


\PYGZsq{} Extract the error text from an HTTP object.
\PYGZsq{}
Function getHttpErrorText(http As Object) As String

   If (http.Status = 200) Then \PYGZsq{} Request successful
      getHttpErrorText = \PYGZdq{}\PYGZdq{}
      Exit Function
   End If

   getHttpErrorText = \PYGZdq{}Status code : \PYGZdq{} \PYGZam{} http.Status \PYGZam{} vbCrLf \PYGZus{}
                     \PYGZam{} \PYGZdq{}Status text : \PYGZdq{} \PYGZam{} http.statusText
End Function


\PYGZsq{} Append the User/Pass/DSName params to the provided base URL
\PYGZsq{}
\PYGZsq{} TODO : Add some HTML\PYGZhy{}escaping on the extracted value
\PYGZsq{}
Function buildBaseUrl(baseURL As String, usrName As String, usrPass As String, system As String, trans As String, custNo As String)

   Dim url As String
   Dim host As String
   Dim port As String

   \PYGZsq{}\PYGZhy{}\PYGZhy{} host = LTrim(RTrim(ActiveSheet.Range(g\PYGZus{}virtelHostRange).Value))
   \PYGZsq{}\PYGZhy{}\PYGZhy{} port = LTrim(RTrim(ActiveSheet.Range(g\PYGZus{}virtelPortRange).Value))

   url = \PYGZdq{}http://\PYGZdq{} \PYGZam{} host \PYGZam{} \PYGZdq{}:\PYGZdq{} \PYGZam{} port \PYGZam{} baseURL
   url = url \PYGZam{} system

   If (InStr(1, baseURL, \PYGZdq{}?\PYGZdq{}) \PYGZlt{} 1) Then
      url = url \PYGZam{} \PYGZdq{}?\PYGZdq{}
   Else
      url = url \PYGZam{} \PYGZdq{}\PYGZam{}\PYGZdq{}
   End If

   url = url \PYGZam{} \PYGZdq{}userName=\PYGZdq{} \PYGZam{} LTrim(RTrim(usrName))
   url = url \PYGZam{} \PYGZdq{}\PYGZam{}password=\PYGZdq{} \PYGZam{} LTrim(RTrim(usrPass))
   url = url \PYGZam{} \PYGZdq{}\PYGZam{}trans=\PYGZdq{} \PYGZam{} LTrim(RTrim(trans))
   url = url \PYGZam{} \PYGZdq{}\PYGZam{}custNo=\PYGZdq{} \PYGZam{} LTrim(RTrim(custNo))


   buildBaseUrl = url

End Function


\PYGZsq{} Extract the \PYGZsq{}URL params\PYGZsq{} from the active sheet, in the specified cells range,
\PYGZsq{} and return them as an URL parameters string.
\PYGZsq{} The parameters extraction stops when the first empty name\PYGZsq{}s cell is encountered.
\PYGZsq{}
\PYGZsq{} TODO : Add some HTML\PYGZhy{}escaping on the extracted value
\PYGZsq{}
Function buildUrlParams(paramsRange As String) As String

   Dim cells As Variant
   Dim res As String, prmName As String
   Dim idx As Long
   Dim sep As String

   cells = ActiveSheet.Range(paramsRange).Value

   For idx = LBound(cells, 1) To UBound(cells, 1)
      prmName = cells(idx, 1)
      If (prmName = \PYGZdq{}\PYGZdq{}) Then Exit For
      res = res \PYGZam{} sep \PYGZam{} prmName \PYGZam{} \PYGZdq{}=\PYGZdq{} \PYGZam{} cells(idx, 2)
      sep = \PYGZdq{}\PYGZam{}\PYGZdq{}
   Next

   buildUrlParams = res

End Function


\PYGZsq{} Merges a base URL and an (optionnal) parameters into a full URL address.
\PYGZsq{}
Function buildURL(ByVal baseURL As String, Optional ByVal params As String = \PYGZdq{}\PYGZdq{}) As String

   Dim separator As String

   If (params \PYGZlt{}\PYGZgt{} \PYGZdq{}\PYGZdq{}) Then
      separator = \PYGZdq{}?\PYGZdq{}
      \PYGZsq{} Do not use \PYGZsq{}?\PYGZsq{} if it is already found in the base URL (in such a case, use \PYGZsq{}\PYGZam{}\PYGZsq{} instead)
      If (InStr(baseURL, \PYGZdq{}?\PYGZdq{}) \PYGZgt{} 0) Then separator = \PYGZdq{}\PYGZam{}\PYGZdq{}
      buildURL = baseURL \PYGZam{} separator \PYGZam{} params
   Else
      buildURL = baseURL
   End If

End Function


\PYGZsq{} Save some text into the specified file.
\PYGZsq{}
Private Sub saveTextOld(ByVal path As String, ByVal content As String)

   On Error GoTo saveTextError

   Dim fso As Object
   Dim file As Object

   Set fso = CreateObject(\PYGZdq{}Scripting.FileSystemObject\PYGZdq{})
   Set file = fso.opentextfile(path, 2, True)
   file.Write content
   file.Close
   Exit Sub

saveTextError:
   On Error GoTo 0
   MsgBox Err.Number \PYGZam{} vbLf \PYGZam{} Err.Description, \PYGZdq{}Trace file saving error\PYGZdq{}

End Sub

Private Sub saveText(ByVal path As String, ByVal content As String)

   On Error GoTo saveTextError
   Dim strFile\PYGZus{}Path As String
   strFile\PYGZus{}Path = path
   Open strFile\PYGZus{}Path For Append As \PYGZsh{}1
   Write \PYGZsh{}1, Now() \PYGZam{} \PYGZdq{} : \PYGZdq{} \PYGZam{} content
   Close \PYGZsh{}1

   Exit Sub

saveTextError:
   On Error GoTo 0
   MsgBox Err.Number \PYGZam{} vbLf \PYGZam{} Err.Description, \PYGZdq{}Trace file saving error\PYGZdq{}

End Sub


Private Function saveScreenAndExtractText(ByVal path As String, ByVal content As String) As String

   Dim idx As Long

   idx = InStr(1, content, g\PYGZus{}ScreenTag)
   If (idx \PYGZlt{} 1) Then
      \PYGZsq{} The response does not contain any screen dump
      saveScreenAndExtractText = content
      Exit Function
   End If

   saveScreenAndExtractText = Left(content, idx \PYGZhy{} 1)

   If (Left(content, 3) = \PYGZdq{}KO:\PYGZdq{}) Then
      Sheets(2).Range(g\PYGZus{}ScreenMsgRange).Interior.Color = RGB(255, 255, 64)
      Sheets(2).Range(g\PYGZus{}ScreenMsgRange).Value = \PYGZdq{}  \PYGZdq{} \PYGZam{} Mid(saveScreenAndExtractText, 4)
   End If

   Dim scrData As String
   Dim i As Long
   Dim line As String

   \PYGZsq{} Expected format is:
   \PYGZsq{} (*SCREEN*)\PYGZsh{}01:\PYGZlt{}80 bytes\PYGZgt{}\PYGZsh{}02:\PYGZlt{}80 bytes\PYGZgt{}...\PYGZsh{}24:\PYGZlt{}80 bytes\PYGZgt{}

   idx = idx + Len(g\PYGZus{}ScreenTag) + 4

   For i = 0 To 23
      line = Mid(content, idx + (i * 84), 80)
      Sheets(2).cells(i + g\PYGZus{}ScreenRow, g\PYGZus{}ScreenColumn).Value = line
      scrData = scrData \PYGZam{} line \PYGZam{} vbCrLf
   Next

   Sheets(2).Select
   Sheets(2).Range(g\PYGZus{}ScreenMsgRange).Select

   \PYGZsq{} Save the screen content into the specified trace file
   Call saveText(path, scrData)

End Function


Private Sub ClearScreen()

   Dim i As Integer
   For i = 0 To 23
      Sheets(2).cells(i + g\PYGZus{}ScreenRow, g\PYGZus{}ScreenColumn).ClearContents
   Next
   Sheets(2).Range(g\PYGZus{}ScreenMsgRange).ClearContents
   Sheets(2).Range(g\PYGZus{}ScreenMsgRange).Interior.Color = RGB(255, 255, 255)

End Sub


\PYGZsq{} Clear the specified range of cells
\PYGZsq{}
Sub clearCells(ByVal targetRange As String, Optional ByVal cols As Long = 1)

   Dim cell As Range

   For Each cell In ActiveSheet.Range(targetRange).cells
      cell.ClearContents
      If (cols \PYGZgt{} 1) Then
            Dim c As Long
            For c = 2 To cols
               cells(cell.row, cell.Column + c \PYGZhy{} 1).ClearContents
            Next
      End If
   Next

End Sub
\end{sphinxVerbatim}



\renewcommand{\indexname}{Index}
\printindex
\end{document}